<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Guardias 2026 - Sistema de Gesti√≥n</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        :root {
            --primary-color: #4CAF50;
            --secondary-color: #2196F3;
            --danger-color: #e74c3c;
            --warning-color: #f39c12;
            --dark-color: #2c3e50;
            --light-color: #f8f9fa;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }
        
        .container {
            max-width: 1400px;
            margin: 0 auto;
            background: white;
            border-radius: 20px;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
            padding: 30px;
        }
        
        header {
            text-align: center;
            margin-bottom: 40px;
            padding-bottom: 20px;
            border-bottom: 3px solid var(--primary-color);
        }
        
        h1 {
            font-size: 2.5em;
            color: var(--dark-color);
            margin-bottom: 10px;
        }
        
        .subtitle {
            color: #7f8c8d;
            font-size: 1.2em;
        }
        
        .controls {
            display: flex;
            flex-wrap: wrap;
            gap: 15px;
            margin-bottom: 30px;
            justify-content: center;
        }
        
        .btn {
            padding: 12px 24px;
            background: linear-gradient(135deg, #6a11cb 0%, #2575fc 100%);
            color: white;
            border: none;
            border-radius: 10px;
            cursor: pointer;
            font-size: 16px;
            font-weight: 600;
            transition: all 0.3s;
        }
        
        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(0,0,0,0.3);
        }
        
        .btn.active {
            background: var(--primary-color);
        }
        
        .section {
            display: none;
            animation: fadeIn 0.5s;
        }
        
        .section.active {
            display: block;
        }
        
        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }
        
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }
        
        .stat-card {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 20px;
            border-radius: 15px;
            text-align: center;
        }
        
        .stat-number {
            font-size: 2.5em;
            font-weight: bold;
            margin: 10px 0;
        }
        
        .stat-label {
            font-size: 1em;
            opacity: 0.9;
        }
        
        .person-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(250px, 1fr));
            gap: 20px;
        }
        
        .person-card {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 25px;
            border-radius: 15px;
            cursor: pointer;
            transition: all 0.3s;
        }
        
        .person-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 30px rgba(0,0,0,0.3);
        }
        
        .person-name {
            font-size: 1.5em;
            font-weight: bold;
            margin-bottom: 10px;
        }
        
        .calendar-month {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
            background: white;
            border-radius: 10px;
            overflow: hidden;
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
        }
        
        .calendar-month th {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 15px;
            font-weight: 700;
        }
        
        .calendar-month td {
            padding: 10px;
            border: 1px solid #e0e0e0;
            vertical-align: top;
            min-height: 100px;
            position: relative;
        }
        
        .day-number {
            font-weight: bold;
            margin-bottom: 5px;
            color: var(--dark-color);
        }
        
        .today {
            background: #fff3cd !important;
        }
        
        .guardia-event {
            background: var(--primary-color);
            color: white;
            padding: 3px 6px;
            margin: 2px 0;
            border-radius: 5px;
            font-size: 0.75em;
            display: block;
        }
        
        .festivo-day {
            background: rgba(231, 76, 60, 0.1) !important;
        }
        
        .festivo-label {
            background: var(--danger-color);
            color: white;
            padding: 3px 6px;
            border-radius: 5px;
            font-size: 0.7em;
            display: block;
            margin-top: 5px;
        }
        
        .vacaciones-event {
            background: var(--secondary-color);
            color: white;
            padding: 3px 6px;
            margin: 2px 0;
            border-radius: 5px;
            font-size: 0.75em;
            display: block;
        }
        
        .cal-controls {
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            gap: 15px;
            margin-bottom: 20px;
        }
        
        .cal-title {
            font-size: 1.5em;
            font-weight: bold;
            color: var(--dark-color);
        }
        
        .event-list {
            margin-top: 20px;
        }
        
        .event-item {
            background: var(--light-color);
            padding: 15px;
            margin-bottom: 10px;
            border-radius: 10px;
            border-left: 4px solid var(--primary-color);
        }
        
        .event-date {
            font-weight: bold;
            color: var(--dark-color);
        }
        
        .btn-small {
            padding: 8px 16px;
            background: white;
            color: var(--dark-color);
            border: 2px solid white;
            border-radius: 8px;
            cursor: pointer;
            font-size: 0.85em;
            font-weight: 600;
            transition: all 0.3s;
        }
        
        .btn-small:hover {
            background: rgba(255, 255, 255, 0.2);
            border-color: rgba(255, 255, 255, 0.5);
            transform: translateY(-2px);
        }
        
        /* Controles de edici√≥n solo en modo local */
        .edit-controls {
            display: none;
        }
        
        .local-mode .edit-controls {
            display: block;
        }
        
        .btn-edit {
            padding: 6px 12px;
            background: var(--warning-color);
            color: white;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 0.8em;
            font-weight: 600;
            margin-top: 5px;
            transition: all 0.3s;
        }
        
        .btn-edit:hover {
            background: #e67e22;
            transform: scale(1.05);
        }
        
        .guardia-item {
            background: rgba(255, 255, 255, 0.2);
            padding: 8px;
            margin: 5px 0;
            border-radius: 6px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        /* Modal para intercambio */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.7);
            z-index: 1000;
            justify-content: center;
            align-items: center;
        }
        
        .modal.active {
            display: flex;
        }
        
        .modal-content {
            background: white;
            padding: 30px;
            border-radius: 15px;
            max-width: 500px;
            width: 90%;
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.3);
        }
        
        .modal-header {
            font-size: 1.5em;
            font-weight: bold;
            margin-bottom: 20px;
            color: var(--dark-color);
        }
        
        .modal-body {
            margin-bottom: 20px;
        }
        
        .modal-footer {
            display: flex;
            gap: 10px;
            justify-content: flex-end;
        }
        
        .form-group {
            margin-bottom: 15px;
        }
        
        .form-group label {
            display: block;
            margin-bottom: 5px;
            font-weight: 600;
            color: var(--dark-color);
        }
        
        .form-group select {
            width: 100%;
            padding: 10px;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            font-size: 1em;
        }
        
        .btn-cancel {
            padding: 10px 20px;
            background: #95a5a6;
            color: white;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 600;
        }
        
        .btn-confirm {
            padding: 10px 20px;
            background: var(--primary-color);
            color: white;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 600;
        }
        
        .alert {
            padding: 15px;
            margin-bottom: 20px;
            border-radius: 8px;
            font-weight: 600;
        }
        
        .alert-info {
            background: #d1ecf1;
            color: #0c5460;
            border: 1px solid #bee5eb;
        }
        
        .alert-warning {
            background: #fff3cd;
            color: #856404;
            border: 1px solid #ffeaa7;
        }
        
        .conflict-item {
            background: linear-gradient(135deg, #ff6b6b, #ee5a6f);
            color: white;
            padding: 20px;
            margin-bottom: 15px;
            border-radius: 12px;
            box-shadow: 0 4px 15px rgba(255, 107, 107, 0.3);
        }
        
        .conflict-header {
            font-size: 1.3em;
            font-weight: bold;
            margin-bottom: 10px;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .conflict-details {
            background: rgba(255, 255, 255, 0.2);
            padding: 15px;
            border-radius: 8px;
            margin-top: 10px;
        }
        
        .conflict-badge {
            background: var(--warning-color);
            padding: 5px 12px;
            border-radius: 20px;
            font-size: 0.85em;
            font-weight: bold;
        }
        
        .no-conflicts {
            text-align: center;
            padding: 40px;
            background: linear-gradient(135deg, #11998e, #38ef7d);
            color: white;
            border-radius: 15px;
            font-size: 1.2em;
            font-weight: bold;
        }
        
        .vacation-highlight {
            background: rgba(33, 150, 243, 0.3) !important;
            border: 2px solid var(--secondary-color) !important;
        }
        
        .conflict-highlight {
            background: rgba(255, 107, 107, 0.3) !important;
            border: 2px solid #ff6b6b !important;
            animation: pulse 2s infinite;
        }
        
        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.7; }
        }
        
        .gestion-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 25px;
            margin-top: 20px;
        }
        
        .gestion-card {
            background: white;
            border: 2px solid #e0e0e0;
            border-radius: 15px;
            padding: 25px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
        }
        
        .gestion-card h3 {
            margin-bottom: 20px;
            color: var(--dark-color);
            font-size: 1.3em;
        }
        
        .form-input {
            width: 100%;
            padding: 12px;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            font-size: 1em;
            margin-top: 5px;
            transition: border-color 0.3s;
        }
        
        .form-input:focus {
            outline: none;
            border-color: var(--primary-color);
        }
        
        .btn-confirm, .btn-cancel {
            width: 100%;
            margin-top: 15px;
        }
        
        .guardia-huerfana {
            background: #ffe6e6;
            border: 2px solid var(--danger-color);
            padding: 15px;
            border-radius: 10px;
            margin-bottom: 10px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .btn-reasignar {
            padding: 8px 16px;
            background: var(--primary-color);
            color: white;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-weight: 600;
        }
        
        .spinner {
            border: 4px solid #f3f3f3;
            border-top: 4px solid var(--primary-color);
            border-radius: 50%;
            width: 50px;
            height: 50px;
            animation: spin 1s linear infinite;
            margin: 0 auto;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        .dia-checkbox {
            display: flex;
            align-items: center;
            padding: 8px;
            margin: 5px 0;
            background: white;
            border-radius: 6px;
            cursor: pointer;
            transition: background 0.2s;
        }
        
        .dia-checkbox:hover {
            background: #e8f5e9;
        }
        
        .dia-checkbox input[type="checkbox"] {
            margin-right: 10px;
            width: 18px;
            height: 18px;
            cursor: pointer;
        }
        
        .dia-checkbox label {
            cursor: pointer;
            flex: 1;
            margin: 0;
        }
        
        @media (max-width: 768px) {
            .container {
                padding: 15px;
            }
            
            .controls {
                flex-direction: column;
            }
            
            .calendar-month td {
                padding: 5px;
                font-size: 0.85em;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- Alerta de modo local -->
        <div class="edit-controls">
            <div class="alert alert-info">
                ‚ÑπÔ∏è <strong>Modo Local:</strong> Puedes intercambiar guardias entre t√©cnicos. Los cambios se guardar√°n en tu navegador.
                <button class="btn-small" onclick="mostrarConfigGithub()" style="margin-top: 10px;">
                    üîß Configurar GitHub
                </button>
            </div>
        </div>
        
        <header>
            <h1>üìÖ Guardias 2026</h1>
            <div class="subtitle">Sistema de visualizaci√≥n de guardias, festivos y vacaciones</div>
        </header>
        
        <div class="controls">
            <button class="btn active" onclick="showSection('resumen')">üìä Resumen</button>
            <button class="btn" onclick="showSection('personas')">üë• Personas</button>
            <button class="btn" onclick="showSection('calendario')">üìÖ Calendario</button>
            <button class="btn" onclick="showSection('conflictos')">‚ö†Ô∏è Conflictos</button>
            <button class="btn edit-controls" onclick="showSection('gestion')" style="background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);">
                ‚öôÔ∏è Gesti√≥n
            </button>
            <button class="btn" onclick="showSection('hoy')">üéØ Hoy</button>
            <button class="btn" onclick="showSection('festivos')">üéä Festivos</button>
            <button class="btn" onclick="showSection('vacaciones')">üèñÔ∏è Vacaciones</button>
            <button class="btn edit-controls" onclick="subirCambiosGithub()" style="background: linear-gradient(135deg, #24C6DC 0%, #514A9D 100%);">
                ‚òÅÔ∏è Subir a GitHub
            </button>
            <button class="btn edit-controls" onclick="resetearGuardias()" style="background: var(--danger-color);">
                üîÑ Resetear Cambios
            </button>
        </div>
        
        <div id="resumen" class="section active">
            <h2>üìä Resumen General</h2>
            <div class="stats-grid" id="stats-grid">
                <div class="stat-card">
                    <div class="stat-label">Total Personas</div>
                    <div class="stat-number" id="total-personas">0</div>
                </div>
            </div>
            <div class="person-grid" id="resumen-grid"></div>
        </div>
        
        <div id="personas" class="section">
            <h2>üë• Personas y sus Guardias</h2>
            <div class="person-grid" id="personas-grid"></div>
        </div>
        
        <div id="calendario" class="section">
            <h2>üìÖ Calendario de Guardias</h2>
            <div class="cal-controls">
                <button class="btn" onclick="prevMonth()">‚óÄ Anterior</button>
                <div class="cal-title" id="calendar-title"></div>
                <button class="btn" onclick="nextMonth()">Siguiente ‚ñ∂</button>
            </div>
            <table class="calendar-month" id="calendar-month"></table>
        </div>
        
        <div id="conflictos" class="section">
            <h2>‚ö†Ô∏è Detecci√≥n de Conflictos</h2>
            <div class="alert alert-info">
                Esta secci√≥n detecta autom√°ticamente cuando un t√©cnico tiene guardia durante sus vacaciones.
            </div>
            <div id="conflictos-list"></div>
        </div>
        
        <div id="gestion" class="section">
            <h2>‚öôÔ∏è Gesti√≥n del Sistema</h2>
            <div class="alert alert-warning">
                ‚ö†Ô∏è Solo disponible en modo local. Los cambios se guardan en tu navegador.
            </div>
            
            <div class="gestion-grid">
                <!-- Gesti√≥n de T√©cnicos -->
                <div class="gestion-card">
                    <h3>üë• Gesti√≥n de T√©cnicos</h3>
                    <div class="form-group">
                        <label>Nuevo t√©cnico:</label>
                        <input type="text" id="input-nuevo-tecnico" placeholder="Nombre del t√©cnico" class="form-input">
                        <button class="btn-confirm" onclick="a√±adirTecnico()">‚ûï A√±adir T√©cnico</button>
                    </div>
                    <div class="form-group" style="margin-top: 20px;">
                        <label>Eliminar t√©cnico:</label>
                        <select id="select-eliminar-tecnico" class="form-input">
                            <option value="">Selecciona un t√©cnico...</option>
                        </select>
                        <button class="btn-cancel" onclick="eliminarTecnico()">üóëÔ∏è Eliminar T√©cnico</button>
                    </div>
                </div>
                
                <!-- Gesti√≥n de Guardias -->
                <div class="gestion-card">
                    <h3>üìÖ A√±adir Guardia</h3>
                    <div class="form-group">
                        <label>T√©cnico:</label>
                        <select id="select-tecnico-guardia" class="form-input">
                            <option value="">Selecciona un t√©cnico...</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>Fecha inicio:</label>
                        <input type="date" id="input-guardia-inicio" class="form-input">
                    </div>
                    <div class="form-group">
                        <label>Fecha fin:</label>
                        <input type="date" id="input-guardia-fin" class="form-input">
                    </div>
                    <button class="btn-confirm" onclick="a√±adirGuardia()">‚ûï A√±adir Guardia</button>
                </div>
                
                <!-- Gesti√≥n de Vacaciones -->
                <div class="gestion-card">
                    <h3>üèñÔ∏è A√±adir Vacaciones</h3>
                    <div class="form-group">
                        <label>T√©cnico:</label>
                        <select id="select-tecnico-vacaciones" class="form-input">
                            <option value="">Selecciona un t√©cnico...</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>Fecha inicio:</label>
                        <input type="date" id="input-vacaciones-inicio" class="form-input">
                    </div>
                    <div class="form-group">
                        <label>Fecha fin:</label>
                        <input type="date" id="input-vacaciones-fin" class="form-input">
                    </div>
                    <div class="form-group">
                        <label>Descripci√≥n:</label>
                        <input type="text" id="input-vacaciones-desc" placeholder="Ej: Vacaciones verano" class="form-input">
                    </div>
                    <button class="btn-confirm" onclick="a√±adirVacaciones()">‚ûï A√±adir Vacaciones</button>
                </div>
                
                <!-- Gesti√≥n de Festivos -->
                <div class="gestion-card">
                    <h3>üéä A√±adir Festivo / D√≠a Especial</h3>
                    <div class="form-group">
                        <label>Fecha:</label>
                        <input type="date" id="input-festivo-fecha" class="form-input">
                    </div>
                    <div class="form-group">
                        <label>Nombre:</label>
                        <input type="text" id="input-festivo-nombre" placeholder="Ej: Navidad" class="form-input">
                    </div>
                    <div class="form-group">
                        <label>
                            <input type="checkbox" id="check-medio-dia"> Medio d√≠a
                        </label>
                    </div>
                    <button class="btn-confirm" onclick="a√±adirFestivo()">‚ûï A√±adir Festivo</button>
                </div>
            </div>
            
            <!-- Lista de guardias hu√©rfanas -->
            <div id="guardias-huerfanas" style="margin-top: 30px; display: none;">
                <h3 style="color: var(--danger-color);">‚ö†Ô∏è Guardias sin asignar (T√©cnico eliminado)</h3>
                <div class="alert alert-warning">
                    Estas guardias necesitan ser reasignadas a otro t√©cnico.
                </div>
                <div id="lista-guardias-huerfanas"></div>
            </div>
        </div>
        
        <div id="hoy" class="section">
            <h2>üéØ ¬øQui√©n tiene guardia hoy?</h2>
            <div id="hoy-content"></div>
        </div>
        
        <div id="festivos" class="section">
            <h2>üéä Festivos durante guardias</h2>
            <div class="event-list" id="festivos-list"></div>
        </div>
        
        <div id="vacaciones" class="section">
            <h2>üèñÔ∏è Per√≠odos de Vacaciones</h2>
            <div class="event-list" id="vacaciones-list"></div>
        </div>
    </div>

    <!-- Modal para intercambio de guardias -->
    <div id="modal-intercambio" class="modal">
        <div class="modal-content">
            <div class="modal-header">üîÑ Intercambiar Guardia</div>
            <div class="modal-body">
                <div class="alert alert-info" style="font-size: 0.9em; margin-bottom: 15px;">
                    Puedes intercambiar la guardia completa o solo d√≠as espec√≠ficos
                </div>
                
                <div class="form-group">
                    <label>Guardia a intercambiar:</label>
                    <div id="guardia-origen" style="padding: 10px; background: #f0f0f0; border-radius: 6px; margin-bottom: 15px;"></div>
                </div>
                
                <div class="form-group">
                    <label>Tipo de intercambio:</label>
                    <select id="select-tipo-intercambio" class="form-control" onchange="cambiarTipoIntercambio()">
                        <option value="completo">Semana completa</option>
                        <option value="dias">D√≠as espec√≠ficos</option>
                    </select>
                </div>
                
                <!-- Selector de d√≠as espec√≠ficos -->
                <div id="selector-dias" style="display: none;">
                    <div class="form-group">
                        <label>Selecciona los d√≠as a pasar:</label>
                        <div id="dias-disponibles" style="background: #f9f9f9; padding: 15px; border-radius: 8px; max-height: 200px; overflow-y: auto;"></div>
                    </div>
                </div>
                
                <div class="form-group">
                    <label>Pasar a:</label>
                    <select id="select-persona-destino" class="form-control">
                        <option value="">Selecciona un t√©cnico...</option>
                    </select>
                </div>
                
                <!-- Solo para intercambio completo -->
                <div id="selector-guardia-destino">
                    <div class="form-group">
                        <label>Guardia del otro t√©cnico:</label>
                        <select id="select-guardia-destino" class="form-control">
                            <option value="">Selecciona una guardia...</option>
                        </select>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn-cancel" onclick="cerrarModalIntercambio()">Cancelar</button>
                <button class="btn-confirm" onclick="confirmarIntercambio()">Confirmar</button>
            </div>
        </div>
    </div>

    <!-- Modal para configuraci√≥n de GitHub -->
    <div id="modal-github-config" class="modal">
        <div class="modal-content" style="max-width: 600px;">
            <div class="modal-header">üîß Configuraci√≥n de GitHub</div>
            <div class="modal-body">
                <div class="alert alert-info" style="font-size: 0.9em;">
                    Para subir cambios a GitHub necesitas configurar estos datos. 
                    <strong>Tu token NO se env√≠a a ning√∫n servidor, solo se guarda en tu navegador.</strong>
                </div>
                
                <div class="form-group">
                    <label>Usuario de GitHub:</label>
                    <input type="text" id="input-github-user" class="form-input" placeholder="tu-usuario">
                </div>
                
                <div class="form-group">
                    <label>Nombre del repositorio:</label>
                    <input type="text" id="input-github-repo" class="form-input" placeholder="guardias-2026">
                </div>
                
                <div class="form-group">
                    <label>Rama (branch):</label>
                    <input type="text" id="input-github-branch" class="form-input" value="main" placeholder="main">
                </div>
                
                <div class="form-group">
                    <label>Token de acceso personal:</label>
                    <input type="password" id="input-github-token" class="form-input" placeholder="ghp_...">
                    <small style="display: block; margin-top: 5px; color: #666;">
                        El token se guarda encriptado en tu navegador
                    </small>
                </div>
                
                <div class="alert alert-warning" style="font-size: 0.85em; margin-top: 15px;">
                    <strong>‚ö†Ô∏è Instrucciones para crear el token:</strong><br>
                    1. Ve a GitHub.com ‚Üí Settings ‚Üí Developer settings<br>
                    2. Personal access tokens ‚Üí Tokens (classic)<br>
                    3. Generate new token ‚Üí Marca "repo" (acceso completo)<br>
                    4. Copia el token y p√©galo aqu√≠
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn-cancel" onclick="cerrarModalGithubConfig()">Cancelar</button>
                <button class="btn-confirm" onclick="guardarConfigGithub()">üíæ Guardar Configuraci√≥n</button>
            </div>
        </div>
    </div>

    <!-- Modal de progreso de subida -->
    <div id="modal-github-progress" class="modal">
        <div class="modal-content" style="max-width: 500px;">
            <div class="modal-header">‚òÅÔ∏è Subiendo a GitHub</div>
            <div class="modal-body">
                <div id="github-progress-content" style="text-align: center; padding: 20px;">
                    <div class="spinner"></div>
                    <div id="github-status" style="margin-top: 20px; font-weight: 600;"></div>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal para editar vacaciones -->
    <div id="modal-editar-vacaciones" class="modal">
        <div class="modal-content" style="max-width: 500px;">
            <div class="modal-header">‚úèÔ∏è Editar Vacaciones</div>
            <div class="modal-body">
                <div class="form-group">
                    <label>T√©cnico:</label>
                    <input type="text" id="edit-vacaciones-tecnico" class="form-input" readonly style="background: #f0f0f0;">
                </div>
                <div class="form-group">
                    <label>Fecha inicio:</label>
                    <input type="date" id="edit-vacaciones-inicio" class="form-input">
                </div>
                <div class="form-group">
                    <label>Fecha fin:</label>
                    <input type="date" id="edit-vacaciones-fin" class="form-input">
                </div>
                <div class="form-group">
                    <label>Descripci√≥n:</label>
                    <input type="text" id="edit-vacaciones-desc" class="form-input" placeholder="Ej: Vacaciones verano">
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn-cancel" onclick="cerrarModalEditarVacaciones()">Cancelar</button>
                <button class="btn-confirm" onclick="guardarEdicionVacaciones()">üíæ Guardar Cambios</button>
            </div>
        </div>
    </div>

    <!-- Modal para editar guardias -->
    <div id="modal-editar-guardia" class="modal">
        <div class="modal-content" style="max-width: 500px;">
            <div class="modal-header">‚úèÔ∏è Editar Guardia</div>
            <div class="modal-body">
                <div class="form-group">
                    <label>T√©cnico:</label>
                    <input type="text" id="edit-guardia-tecnico" class="form-input" readonly style="background: #f0f0f0;">
                </div>
                <div class="form-group">
                    <label>Fecha inicio:</label>
                    <input type="date" id="edit-guardia-inicio" class="form-input">
                </div>
                <div class="form-group">
                    <label>Fecha fin:</label>
                    <input type="date" id="edit-guardia-fin" class="form-input">
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn-cancel" onclick="cerrarModalEditarGuardia()">Cancelar</button>
                <button class="btn-confirm" onclick="guardarEdicionGuardia()">üíæ Guardar Cambios</button>
            </div>
        </div>
    </div>

    <!-- Indicador de carga -->
    <div id="loading-overlay" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.8); z-index: 9999; justify-content: center; align-items: center; flex-direction: column;">
        <div style="background: white; padding: 30px; border-radius: 10px; text-align: center;">
            <div style="font-size: 24px; margin-bottom: 15px;">‚è≥ Cargando datos...</div>
            <div id="loading-status" style="font-size: 14px; color: #666;"></div>
        </div>
    </div>

    <script>
        // DATOS INTEGRADOS EN EL HTML
        // Datos que se cargar√°n desde archivos JSON
        let TECNICOS = {};
        let GUARDIAS = {};
        let VACACIONES = {};
        let FESTIVOS = {};

        // Funci√≥n para cargar datos desde JSON
        async function cargarDatosDesdeJSON() {
            const overlay = document.getElementById('loading-overlay');
            const status = document.getElementById('loading-status');
            
            overlay.style.display = 'flex';
            
            try {
                console.log('üîÑ Cargando datos desde archivos JSON...');
                
                // Cargar tecnicos.json
                status.textContent = 'Cargando t√©cnicos...';
                console.log('üì• Solicitando tecnicos.json...');
                const respTecnicos = await fetch('tecnicos.json');
                console.log('üìä Respuesta tecnicos.json:', respTecnicos.status, respTecnicos.statusText);
                if (!respTecnicos.ok) throw new Error(`No se pudo cargar tecnicos.json (${respTecnicos.status})`);
                TECNICOS = await respTecnicos.json();
                console.log('‚úÖ T√©cnicos cargados:', Object.keys(TECNICOS).length, 't√©cnicos');
                
                // Cargar guardias.json
                status.textContent = 'Cargando guardias...';
                console.log('üì• Solicitando guardias.json...');
                const respGuardias = await fetch('guardias.json');
                console.log('üìä Respuesta guardias.json:', respGuardias.status, respGuardias.statusText);
                if (!respGuardias.ok) throw new Error(`No se pudo cargar guardias.json (${respGuardias.status})`);
                GUARDIAS = await respGuardias.json();
                console.log('‚úÖ Guardias cargadas:', Object.keys(GUARDIAS).length, 't√©cnicos');
                
                // Cargar vacaciones.json
                status.textContent = 'Cargando vacaciones...';
                console.log('üì• Solicitando vacaciones.json...');
                const respVacaciones = await fetch('vacaciones.json');
                console.log('üìä Respuesta vacaciones.json:', respVacaciones.status, respVacaciones.statusText);
                if (!respVacaciones.ok) throw new Error(`No se pudo cargar vacaciones.json (${respVacaciones.status})`);
                VACACIONES = await respVacaciones.json();
                console.log('‚úÖ Vacaciones cargadas:', Object.keys(VACACIONES).length, 'personas');
                
                // Cargar festivos.json
                status.textContent = 'Cargando festivos...';
                console.log('üì• Solicitando festivos.json...');
                const respFestivos = await fetch('festivos.json');
                console.log('üìä Respuesta festivos.json:', respFestivos.status, respFestivos.statusText);
                if (!respFestivos.ok) throw new Error(`No se pudo cargar festivos.json (${respFestivos.status})`);
                FESTIVOS = await respFestivos.json();
                console.log('‚úÖ Festivos cargados:', Object.keys(FESTIVOS).length, 'festivos');
                
                status.textContent = '‚úÖ ¬°Todos los datos cargados!';
                console.log('üéâ Todos los datos cargados correctamente');
                
                setTimeout(() => {
                    overlay.style.display = 'none';
                }, 500);
                
                return true;
                
            } catch (error) {
                console.error('‚ùå Error cargando datos:', error);
                status.textContent = '‚ùå Error: ' + error.message;
                
                setTimeout(() => {
                    overlay.style.display = 'none';
                    alert('‚ùå Error cargando datos desde los archivos JSON.\n\n' + error.message + '\n\nAseg√∫rate de que los archivos tecnicos.json, guardias.json, vacaciones.json y festivos.json est√©n en la misma carpeta que index.html\n\nAbre la consola (F12) para m√°s detalles.');
                }, 2000);
                
                return false;
            }
        }

        let currentYear = 2026;
        let currentMonth = 0;
        let isLocalMode = false;

        // Detectar si estamos en modo local o GitHub Pages
        function detectarEntorno() {
            // Detectar si estamos en local (file:// o localhost)
            isLocalMode = window.location.protocol === 'file:' || 
                         window.location.hostname === 'localhost' || 
                         window.location.hostname === '127.0.0.1' ||
                         window.location.hostname === '';
            
            console.log('Modo:', isLocalMode ? 'LOCAL (edici√≥n habilitada)' : 'GITHUB (solo lectura)');
            
            // Mostrar/ocultar controles de edici√≥n
            if (isLocalMode) {
                document.body.classList.add('local-mode');
            }
        }

        async function inicializarApp() {
            detectarEntorno();
            
            // Primero cargar datos desde JSON (GitHub Pages)
            if (!isLocalMode) {
                const cargado = await cargarDatosDesdeJSON();
                if (!cargado) return; // Si falla, no continuar
            }
            
            // En modo local, sobreescribir con localStorage si existe
            if (isLocalMode) {
                const tecnicosGuardados = localStorage.getItem('tecnicos_2026');
                if (tecnicosGuardados) {
                    Object.assign(TECNICOS, JSON.parse(tecnicosGuardados));
                    console.log('T√©cnicos cargados desde localStorage');
                }
                
                const guardiasGuardadas = localStorage.getItem('guardias_2026');
                if (guardiasGuardadas) {
                    Object.assign(GUARDIAS, JSON.parse(guardiasGuardadas));
                    console.log('Guardias cargadas desde localStorage');
                }
                
                const vacacionesGuardadas = localStorage.getItem('vacaciones_2026');
                if (vacacionesGuardadas) {
                    Object.assign(VACACIONES, JSON.parse(vacacionesGuardadas));
                    console.log('Vacaciones cargadas desde localStorage');
                }
                
                const festivosGuardados = localStorage.getItem('festivos_2026');
                if (festivosGuardados) {
                    Object.assign(FESTIVOS, JSON.parse(festivosGuardados));
                    console.log('Festivos cargados desde localStorage');
                }
            }
            
            const hoy = new Date();
            currentYear = hoy.getFullYear();
            currentMonth = hoy.getMonth();
            
            cargarResumen();
            cargarPersonas();
            updateCalendar();
            cargarConflictos();
            cargarHoy();
            cargarFestivos();
            cargarVacacionesLista();
            actualizarSelectsTecnicos();
            mostrarGuardiasHuerfanas();
        }

        function showSection(sectionId) {
            document.querySelectorAll('.section').forEach(s => s.classList.remove('active'));
            document.getElementById(sectionId).classList.add('active');
            
            document.querySelectorAll('.btn').forEach(btn => btn.classList.remove('active'));
            event.target.classList.add('active');
            
            // Cargar contenido espec√≠fico de la secci√≥n
            if (sectionId === 'conflictos') {
                cargarConflictos();
            } else if (sectionId === 'gestion') {
                actualizarSelectsTecnicos();
                mostrarGuardiasHuerfanas();
            }
        }

        function cargarResumen() {
            const grid = document.getElementById('resumen-grid');
            grid.innerHTML = '';
            
            // Contar guardias, vacaciones y festivos por a√±o
            const guardiasPorA√±o = {};
            const vacacionesPorA√±o = {};
            const festivosPorA√±o = {};
            
            // Contar guardias
            for (const [persona, guardias] of Object.entries(GUARDIAS)) {
                guardias.forEach(([inicio]) => {
                    const a√±o = new Date(inicio).getFullYear();
                    guardiasPorA√±o[a√±o] = (guardiasPorA√±o[a√±o] || 0) + 1;
                });
            }
            
            // Mostrar t√©cnicos (de TECNICOS, no de GUARDIAS)
            for (const persona of Object.keys(TECNICOS)) {
                const guardias = GUARDIAS[persona] || [];
                const card = document.createElement('div');
                card.className = 'person-card';
                card.innerHTML = `
                    <div class="person-name">${persona}</div>
                    <div>${guardias.length} guardias asignadas</div>
                `;
                grid.appendChild(card);
            }
            
            // Contar vacaciones
            for (const [persona, vacaciones] of Object.entries(VACACIONES)) {
                vacaciones.forEach(([inicio]) => {
                    const a√±o = new Date(inicio).getFullYear();
                    vacacionesPorA√±o[a√±o] = (vacacionesPorA√±o[a√±o] || 0) + 1;
                });
            }
            
            // Contar festivos
            for (const fecha of Object.keys(FESTIVOS)) {
                const a√±o = new Date(fecha).getFullYear();
                festivosPorA√±o[a√±o] = (festivosPorA√±o[a√±o] || 0) + 1;
            }
            
            // Obtener todos los a√±os √∫nicos y ordenarlos
            const todosLosA√±os = new Set([
                ...Object.keys(guardiasPorA√±o),
                ...Object.keys(vacacionesPorA√±o),
                ...Object.keys(festivosPorA√±o)
            ]);
            const a√±osOrdenados = Array.from(todosLosA√±os).sort();
            
            // Generar stats din√°micamente
            const statsGrid = document.getElementById('stats-grid');
            
            // Total personas siempre aparece
            document.getElementById('total-personas').textContent = Object.keys(TECNICOS).length;
            
            // Agregar stats por a√±o
            a√±osOrdenados.forEach(a√±o => {
                // Guardias
                if (guardiasPorA√±o[a√±o]) {
                    const card = document.createElement('div');
                    card.className = 'stat-card';
                    card.innerHTML = `
                        <div class="stat-label">Guardias ${a√±o}</div>
                        <div class="stat-number">${guardiasPorA√±o[a√±o]}</div>
                    `;
                    statsGrid.appendChild(card);
                }
                
                // Vacaciones
                if (vacacionesPorA√±o[a√±o]) {
                    const card = document.createElement('div');
                    card.className = 'stat-card';
                    card.innerHTML = `
                        <div class="stat-label">Vacaciones ${a√±o}</div>
                        <div class="stat-number">${vacacionesPorA√±o[a√±o]}</div>
                    `;
                    statsGrid.appendChild(card);
                }
                
                // Festivos
                if (festivosPorA√±o[a√±o]) {
                    const card = document.createElement('div');
                    card.className = 'stat-card';
                    card.innerHTML = `
                        <div class="stat-label">Festivos ${a√±o}</div>
                        <div class="stat-number">${festivosPorA√±o[a√±o]}</div>
                    `;
                    statsGrid.appendChild(card);
                }
            });
        }

        function cargarPersonas() {
            const grid = document.getElementById('personas-grid');
            grid.innerHTML = '';
            
            for (const persona of Object.keys(TECNICOS)) {
                const guardias = GUARDIAS[persona] || [];
                const card = document.createElement('div');
                card.className = 'person-card';
                
                let guardiasHTML = '<div style="margin-top: 10px;"><strong>Guardias:</strong></div>';
                guardias.forEach(([inicio, fin], index) => {
                    const inicioDate = new Date(inicio);
                    const finDate = new Date(fin);
                    
                    guardiasHTML += `
                        <div class="guardia-item">
                            <div style="font-size: 0.9em;">
                                ${inicioDate.toLocaleDateString('es-ES')} - ${finDate.toLocaleDateString('es-ES')}
                            </div>
                            ${isLocalMode ? `
                            <div style="display: flex; gap: 5px;">
                                <button class="btn-edit" onclick="abrirModalIntercambio('${persona}', ${index})" title="Intercambiar o pasar d√≠as">
                                    üîÑ
                                </button>
                                <button class="btn-edit" style="font-size: 0.8em; padding: 4px 8px;" onclick="editarGuardia('${persona}', ${index})" title="Editar fechas">
                                    ‚úèÔ∏è
                                </button>
                                <button class="btn-edit" style="font-size: 0.8em; padding: 4px 8px; background: var(--danger-color);" onclick="eliminarGuardia('${persona}', ${index})" title="Eliminar">
                                    üóëÔ∏è
                                </button>
                            </div>
                            ` : ''}
                        </div>
                    `;
                });
                
                // Verificar si tiene vacaciones
                const vacaciones = VACACIONES[persona] || [];
                let vacacionesHTML = '';
                
                if (vacaciones.length > 0) {
                    vacacionesHTML = '<div style="margin-top: 15px; padding-top: 15px; border-top: 2px solid rgba(255,255,255,0.3);"><strong>Vacaciones:</strong></div>';
                    vacaciones.forEach(([inicio, fin, desc], index) => {
                        const inicioDate = new Date(inicio);
                        const finDate = new Date(fin);
                        
                        vacacionesHTML += `
                            <div class="guardia-item" style="background: rgba(33, 150, 243, 0.3);">
                                <div style="font-size: 0.9em;">
                                    ${inicioDate.toLocaleDateString('es-ES')} - ${finDate.toLocaleDateString('es-ES')}<br>
                                    <small style="opacity: 0.9;">${desc || 'Vacaciones'}</small>
                                </div>
                                ${isLocalMode ? `
                                <div style="display: flex; gap: 5px;">
                                    <button class="btn-edit" style="font-size: 0.8em; padding: 4px 8px;" onclick="editarVacaciones('${persona}', ${index})">
                                        ‚úèÔ∏è
                                    </button>
                                    <button class="btn-edit" style="font-size: 0.8em; padding: 4px 8px; background: var(--danger-color);" onclick="eliminarVacaciones('${persona}', ${index})">
                                        üóëÔ∏è
                                    </button>
                                </div>
                                ` : ''}
                            </div>
                        `;
                    });
                }
                
                card.innerHTML = `
                    <div class="person-name">${persona}</div>
                    <div style="margin-top: 10px; opacity: 0.9;">
                        ${guardias.length} guardias ‚Ä¢ ${vacaciones.length} per√≠odos de vacaciones
                    </div>
                    ${guardiasHTML}
                    ${vacacionesHTML}
                    <div style="margin-top: 15px; display: flex; gap: 10px; flex-wrap: wrap;">
                        <button class="btn-small" onclick="exportarGuardiasCalendario('${persona}')">
                            üìÖ Exportar Guardias
                        </button>
                        ${vacaciones.length > 0 ? `
                        <button class="btn-small" onclick="exportarVacacionesCalendario('${persona}')">
                            üèñÔ∏è Exportar Vacaciones
                        </button>
                        ` : ''}
                    </div>
                `;
                grid.appendChild(card);
            }
        }

        function updateCalendar() {
            const calendar = document.getElementById('calendar-month');
            const monthNames = ["Enero", "Febrero", "Marzo", "Abril", "Mayo", "Junio",
                              "Julio", "Agosto", "Septiembre", "Octubre", "Noviembre", "Diciembre"];
            
            document.getElementById('calendar-title').textContent = 
                `${monthNames[currentMonth]} ${currentYear}`;
            
            const firstDay = new Date(currentYear, currentMonth, 1);
            const lastDay = new Date(currentYear, currentMonth + 1, 0);
            let startDay = firstDay.getDay();
            // Ajustar para que lunes sea 0 (domingo era 0, ahora es 6)
            startDay = startDay === 0 ? 6 : startDay - 1;
            const daysInMonth = lastDay.getDate();
            
            let html = `
                <thead>
                    <tr>
                        <th>Lun</th><th>Mar</th><th>Mi√©</th><th>Jue</th>
                        <th>Vie</th><th>S√°b</th><th>Dom</th>
                    </tr>
                </thead>
                <tbody>
            `;
            
            let day = 1;
            const hoy = new Date().toISOString().split('T')[0];
            
            for (let i = 0; i < 6; i++) {
                html += '<tr>';
                for (let j = 0; j < 7; j++) {
                    if (i === 0 && j < startDay || day > daysInMonth) {
                        html += '<td></td>';
                    } else {
                        const dateStr = `${currentYear}-${String(currentMonth + 1).padStart(2, '0')}-${String(day).padStart(2, '0')}`;
                        const isToday = dateStr === hoy;
                        const isFestivo = FESTIVOS[dateStr];
                        
                        // Detectar conflictos para este d√≠a
                        const conflictos = detectarConflictosDelDia(dateStr);
                        const tieneVacaciones = tieneVacacionesDelDia(dateStr);
                        
                        let cellClass = isToday ? 'today' : '';
                        if (isFestivo) cellClass += ' festivo-day';
                        if (conflictos.length > 0) cellClass += ' conflict-highlight';
                        else if (tieneVacaciones) cellClass += ' vacation-highlight';
                        
                        html += `<td class="${cellClass}">
                            <div class="day-number">${day}</div>`;
                        
                        // Agregar guardias
                        for (const [persona, guardias] of Object.entries(GUARDIAS)) {
                            guardias.forEach(([inicio, fin]) => {
                                if (dateStr >= inicio && dateStr <= fin) {
                                    const tieneConflicto = conflictos.some(c => c.persona === persona);
                                    const estiloConflicto = tieneConflicto ? 'style="background: #ff6b6b; font-weight: bold;"' : '';
                                    html += `<span class="guardia-event" ${estiloConflicto}>${persona}${tieneConflicto ? ' ‚ö†Ô∏è' : ''}</span>`;
                                }
                            });
                        }
                        
                        // Agregar vacaciones
                        for (const [persona, vacaciones] of Object.entries(VACACIONES)) {
                            vacaciones.forEach(([inicio, fin, desc]) => {
                                if (dateStr >= inicio && dateStr <= fin) {
                                    html += `<span class="vacaciones-event">${persona}: ${desc || 'Vacaciones'}</span>`;
                                }
                            });
                        }
                        
                        // Agregar festivo
                        if (isFestivo) {
                            html += `<span class="festivo-label">${isFestivo}</span>`;
                        }
                        
                        html += '</td>';
                        day++;
                    }
                }
                html += '</tr>';
                if (day > daysInMonth) break;
            }
            
            html += '</tbody>';
            calendar.innerHTML = html;
        }

        function detectarConflictosDelDia(fecha) {
            const conflictos = [];
            
            for (const [persona, guardias] of Object.entries(GUARDIAS)) {
                const vacaciones = VACACIONES[persona] || [];
                
                guardias.forEach(([guardiaInicio, guardiaFin]) => {
                    if (fecha >= guardiaInicio && fecha <= guardiaFin) {
                        // Verificar si est√° de vacaciones en esta fecha
                        vacaciones.forEach(([vacInicio, vacFin]) => {
                            if (fecha >= vacInicio && fecha <= vacFin) {
                                conflictos.push({ persona });
                            }
                        });
                    }
                });
            }
            
            return conflictos;
        }

        function tieneVacacionesDelDia(fecha) {
            for (const vacaciones of Object.values(VACACIONES)) {
                for (const [inicio, fin] of vacaciones) {
                    if (fecha >= inicio && fecha <= fin) {
                        return true;
                    }
                }
            }
            return false;
        }

        function detectarTodosLosConflictos() {
            const conflictos = [];
            
            for (const [persona, guardias] of Object.entries(GUARDIAS)) {
                const vacaciones = VACACIONES[persona] || [];
                
                guardias.forEach(([guardiaInicio, guardiaFin]) => {
                    vacaciones.forEach(([vacInicio, vacFin, descripcion]) => {
                        // Verificar si hay solapamiento
                        const hayConflicto = !(guardiaFin < vacInicio || guardiaInicio > vacFin);
                        
                        if (hayConflicto) {
                            // Calcular d√≠as de solapamiento
                            const inicio = guardiaInicio > vacInicio ? guardiaInicio : vacInicio;
                            const fin = guardiaFin < vacFin ? guardiaFin : vacFin;
                            
                            const diasConflicto = Math.floor(
                                (new Date(fin) - new Date(inicio)) / (1000 * 60 * 60 * 24)
                            ) + 1;
                            
                            conflictos.push({
                                persona,
                                guardiaInicio,
                                guardiaFin,
                                vacInicio,
                                vacFin,
                                descripcion,
                                inicio,
                                fin,
                                diasConflicto
                            });
                        }
                    });
                });
            }
            
            return conflictos;
        }

        function cargarConflictos() {
            const list = document.getElementById('conflictos-list');
            const conflictos = detectarTodosLosConflictos();
            
            if (conflictos.length === 0) {
                list.innerHTML = `
                    <div class="no-conflicts">
                        ‚úÖ ¬°Perfecto! No hay conflictos entre guardias y vacaciones
                    </div>
                `;
                return;
            }
            
            let html = '';
            
            conflictos.forEach(conf => {
                html += `
                    <div class="conflict-item">
                        <div class="conflict-header">
                            ‚ö†Ô∏è ${conf.persona}
                            <span class="conflict-badge">${conf.diasConflicto} d√≠a${conf.diasConflicto > 1 ? 's' : ''}</span>
                        </div>
                        <div class="conflict-details">
                            <div style="margin-bottom: 8px;">
                                <strong>Guardia:</strong> 
                                ${new Date(conf.guardiaInicio).toLocaleDateString('es-ES')} - 
                                ${new Date(conf.guardiaFin).toLocaleDateString('es-ES')}
                            </div>
                            <div style="margin-bottom: 8px;">
                                <strong>Vacaciones:</strong> 
                                ${new Date(conf.vacInicio).toLocaleDateString('es-ES')} - 
                                ${new Date(conf.vacFin).toLocaleDateString('es-ES')}
                                ${conf.descripcion ? `(${conf.descripcion})` : ''}
                            </div>
                            <div style="background: rgba(255, 255, 255, 0.3); padding: 8px; border-radius: 5px; margin-top: 10px;">
                                <strong>‚ö° Conflicto:</strong> 
                                ${new Date(conf.inicio).toLocaleDateString('es-ES')} - 
                                ${new Date(conf.fin).toLocaleDateString('es-ES')}
                            </div>
                        </div>
                    </div>
                `;
            });
            
            list.innerHTML = html;
        }

        function cargarHoy() {
            const content = document.getElementById('hoy-content');
            const hoy = new Date().toISOString().split('T')[0];
            
            let html = '';
            let hayGuardia = false;
            
            for (const [persona, guardias] of Object.entries(GUARDIAS)) {
                guardias.forEach(([inicio, fin]) => {
                    if (hoy >= inicio && hoy <= fin) {
                        hayGuardia = true;
                        html += `
                            <div class="event-item">
                                <div style="font-size: 1.3em; font-weight: bold; margin-bottom: 5px;">
                                    ${persona}
                                </div>
                                <div class="event-date">
                                    Del ${new Date(inicio).toLocaleDateString('es-ES')} 
                                    al ${new Date(fin).toLocaleDateString('es-ES')}
                                </div>
                            </div>
                        `;
                    }
                });
            }
            
            if (!hayGuardia) {
                html = '<div class="event-item">No hay guardias asignadas para hoy</div>';
            }
            
            content.innerHTML = html;
        }

        function cargarFestivos() {
            const list = document.getElementById('festivos-list');
            let html = '';
            
            // Ordenar festivos por fecha
            const festivosOrdenados = Object.entries(FESTIVOS).sort((a, b) => a[0].localeCompare(b[0]));
            
            for (const [fecha, nombre] of festivosOrdenados) {
                // Ver si hay guardias ese d√≠a
                let personasGuardia = [];
                for (const [persona, guardias] of Object.entries(GUARDIAS)) {
                    guardias.forEach(([inicio, fin]) => {
                        if (fecha >= inicio && fecha <= fin) {
                            personasGuardia.push(persona);
                        }
                    });
                }
                
                if (personasGuardia.length > 0) {
                    html += `
                        <div class="event-item">
                            <div class="event-date">${new Date(fecha).toLocaleDateString('es-ES')} - ${nombre}</div>
                            <div style="margin-top: 5px; color: var(--danger-color); font-weight: bold;">
                                Guardias: ${personasGuardia.join(', ')}
                            </div>
                        </div>
                    `;
                }
            }
            
            if (!html) {
                html = '<div class="event-item">No hay festivos durante guardias</div>';
            }
            
            list.innerHTML = html;
        }

        function cargarVacacionesLista() {
            const list = document.getElementById('vacaciones-list');
            let html = '';
            
            // Crear array con todas las vacaciones y ordenar por fecha
            const todasVacaciones = [];
            for (const [persona, vacaciones] of Object.entries(VACACIONES)) {
                vacaciones.forEach(([inicio, fin, desc]) => {
                    todasVacaciones.push({ persona, inicio, fin, desc });
                });
            }
            
            // Ordenar por fecha de inicio
            todasVacaciones.sort((a, b) => a.inicio.localeCompare(b.inicio));
            
            // Generar HTML
            todasVacaciones.forEach(({ persona, inicio, fin, desc }) => {
                html += `
                    <div class="event-item">
                        <div style="font-weight: bold; margin-bottom: 5px;">${persona}</div>
                        <div class="event-date">
                            ${new Date(inicio).toLocaleDateString('es-ES')} - 
                            ${new Date(fin).toLocaleDateString('es-ES')}
                        </div>
                        <div style="margin-top: 5px; color: var(--secondary-color);">
                            ${desc || 'Vacaciones'}
                        </div>
                    </div>
                `;
            });
            
            list.innerHTML = html;
        }

        function prevMonth() {
            currentMonth--;
            if (currentMonth < 0) {
                currentMonth = 11;
                currentYear--;
            }
            updateCalendar();
        }

        function nextMonth() {
            currentMonth++;
            if (currentMonth > 11) {
                currentMonth = 0;
                currentYear++;
            }
            updateCalendar();
        }

        // Funciones para exportar a calendario
        function generarICS(eventos, titulo) {
            // Formato ICS (iCalendar)
            let ics = `BEGIN:VCALENDAR
VERSION:2.0
PRODID:-//Guardias 2026//ES
CALSCALE:GREGORIAN
METHOD:PUBLISH
X-WR-CALNAME:${titulo}
X-WR-TIMEZONE:Europe/Madrid
BEGIN:VTIMEZONE
TZID:Europe/Madrid
X-LIC-LOCATION:Europe/Madrid
BEGIN:DAYLIGHT
TZOFFSETFROM:+0100
TZOFFSETTO:+0200
TZNAME:CEST
DTSTART:19700329T020000
RRULE:FREQ=YEARLY;BYMONTH=3;BYDAY=-1SU
END:DAYLIGHT
BEGIN:STANDARD
TZOFFSETFROM:+0200
TZOFFSETTO:+0100
TZNAME:CET
DTSTART:19701025T030000
RRULE:FREQ=YEARLY;BYMONTH=10;BYDAY=-1SU
END:STANDARD
END:VTIMEZONE
`;

            eventos.forEach(evento => {
                const uid = `${Date.now()}-${Math.random().toString(36).substr(2, 9)}@guardias.local`;
                const dtstamp = new Date().toISOString().replace(/[-:]/g, '').split('.')[0] + 'Z';
                
                // Convertir fechas a formato ICS (YYYYMMDD)
                const dtstart = evento.inicio.replace(/-/g, '');
                const dtend = evento.fin.replace(/-/g, '');
                
                ics += `BEGIN:VEVENT
DTSTART;VALUE=DATE:${dtstart}
DTEND;VALUE=DATE:${dtend}
DTSTAMP:${dtstamp}
UID:${uid}
SUMMARY:${evento.titulo}
DESCRIPTION:${evento.descripcion || ''}
STATUS:CONFIRMED
TRANSP:TRANSPARENT
END:VEVENT
`;
            });

            ics += `END:VCALENDAR`;
            return ics;
        }

        function descargarICS(contenido, nombreArchivo) {
            const blob = new Blob([contenido], { type: 'text/calendar;charset=utf-8' });
            const url = URL.createObjectURL(blob);
            const link = document.createElement('a');
            link.href = url;
            link.download = nombreArchivo;
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            URL.revokeObjectURL(url);
        }

        function exportarGuardiasCalendario(persona) {
            const guardias = GUARDIAS[persona];
            if (!guardias || guardias.length === 0) {
                alert('No hay guardias para exportar');
                return;
            }

            const eventos = guardias.map(([inicio, fin]) => {
                // Ajustar fecha de fin para que sea inclusive (a√±adir 1 d√≠a)
                const fechaFin = new Date(fin);
                fechaFin.setDate(fechaFin.getDate() + 1);
                const finAjustado = fechaFin.toISOString().split('T')[0];
                
                return {
                    inicio: inicio,
                    fin: finAjustado,
                    titulo: `Guardia - ${persona}`,
                    descripcion: `Per√≠odo de guardia asignado a ${persona}`
                };
            });

            const ics = generarICS(eventos, `Guardias ${persona}`);
            descargarICS(ics, `guardias_${persona.toLowerCase()}.ics`);
        }

        function exportarVacacionesCalendario(persona) {
            const vacaciones = VACACIONES[persona];
            if (!vacaciones || vacaciones.length === 0) {
                alert('No hay vacaciones para exportar');
                return;
            }

            const eventos = vacaciones.map(([inicio, fin, descripcion]) => {
                // Ajustar fecha de fin para que sea inclusive (a√±adir 1 d√≠a)
                const fechaFin = new Date(fin);
                fechaFin.setDate(fechaFin.getDate() + 1);
                const finAjustado = fechaFin.toISOString().split('T')[0];
                
                return {
                    inicio: inicio,
                    fin: finAjustado,
                    titulo: `Vacaciones - ${persona}`,
                    descripcion: descripcion || 'Per√≠odo vacacional'
                };
            });

            const ics = generarICS(eventos, `Vacaciones ${persona}`);
            descargarICS(ics, `vacaciones_${persona.toLowerCase()}.ics`);
        }

        // Variables para el modal de intercambio
        let intercambioActual = {
            personaOrigen: '',
            indexOrigen: -1,
            personaDestino: '',
            indexDestino: -1,
            tipo: 'completo',
            diasSeleccionados: []
        };

        function abrirModalIntercambio(persona, guardiaIndex) {
            intercambioActual.personaOrigen = persona;
            intercambioActual.indexOrigen = guardiaIndex;
            intercambioActual.tipo = 'completo';
            intercambioActual.diasSeleccionados = [];
            
            const guardia = GUARDIAS[persona][guardiaIndex];
            const inicioDate = new Date(guardia[0]);
            const finDate = new Date(guardia[1]);
            
            document.getElementById('guardia-origen').innerHTML = `
                <strong>${persona}</strong><br>
                ${inicioDate.toLocaleDateString('es-ES')} - ${finDate.toLocaleDateString('es-ES')}
            `;
            
            // Reset tipo de intercambio
            document.getElementById('select-tipo-intercambio').value = 'completo';
            document.getElementById('selector-dias').style.display = 'none';
            document.getElementById('selector-guardia-destino').style.display = 'block';
            
            // Generar lista de d√≠as
            generarListaDias(guardia[0], guardia[1]);
            
            // Llenar select de personas (excluyendo la persona actual)
            const selectPersona = document.getElementById('select-persona-destino');
            selectPersona.innerHTML = '<option value="">Selecciona un t√©cnico...</option>';
            
            for (const nombrePersona of Object.keys(GUARDIAS)) {
                if (nombrePersona !== persona) {
                    selectPersona.innerHTML += `<option value="${nombrePersona}">${nombrePersona}</option>`;
                }
            }
            
            // Limpiar select de guardias
            document.getElementById('select-guardia-destino').innerHTML = 
                '<option value="">Primero selecciona un t√©cnico...</option>';
            
            // Event listener para cuando se selecciona una persona
            selectPersona.onchange = function() {
                cargarGuardiasDestino(this.value);
            };
            
            document.getElementById('modal-intercambio').classList.add('active');
        }

        function generarListaDias(inicio, fin) {
            const diasContainer = document.getElementById('dias-disponibles');
            diasContainer.innerHTML = '';
            
            const fechaInicio = new Date(inicio);
            const fechaFin = new Date(fin);
            
            const diasSemana = ['Dom', 'Lun', 'Mar', 'Mi√©', 'Jue', 'Vie', 'S√°b'];
            
            let fechaActual = new Date(fechaInicio);
            
            while (fechaActual <= fechaFin) {
                const fechaStr = fechaActual.toISOString().split('T')[0];
                const diaSemana = diasSemana[fechaActual.getDay()];
                const fechaFormato = fechaActual.toLocaleDateString('es-ES');
                
                const checkboxDiv = document.createElement('div');
                checkboxDiv.className = 'dia-checkbox';
                checkboxDiv.innerHTML = `
                    <input type="checkbox" id="dia-${fechaStr}" value="${fechaStr}">
                    <label for="dia-${fechaStr}">
                        <strong>${diaSemana}</strong> ${fechaFormato}
                    </label>
                `;
                
                diasContainer.appendChild(checkboxDiv);
                
                fechaActual.setDate(fechaActual.getDate() + 1);
            }
        }

        function cambiarTipoIntercambio() {
            const tipo = document.getElementById('select-tipo-intercambio').value;
            intercambioActual.tipo = tipo;
            
            if (tipo === 'dias') {
                document.getElementById('selector-dias').style.display = 'block';
                document.getElementById('selector-guardia-destino').style.display = 'none';
            } else {
                document.getElementById('selector-dias').style.display = 'none';
                document.getElementById('selector-guardia-destino').style.display = 'block';
            }
        }

        function cargarGuardiasDestino(personaDestino) {
            if (!personaDestino) return;
            
            const selectGuardia = document.getElementById('select-guardia-destino');
            selectGuardia.innerHTML = '<option value="">Selecciona una guardia...</option>';
            
            const guardias = GUARDIAS[personaDestino];
            guardias.forEach((guardia, index) => {
                const inicioDate = new Date(guardia[0]);
                const finDate = new Date(guardia[1]);
                selectGuardia.innerHTML += `
                    <option value="${index}">
                        ${inicioDate.toLocaleDateString('es-ES')} - ${finDate.toLocaleDateString('es-ES')}
                    </option>
                `;
            });
        }

        function cerrarModalIntercambio() {
            document.getElementById('modal-intercambio').classList.remove('active');
            intercambioActual = {
                personaOrigen: '',
                indexOrigen: -1,
                personaDestino: '',
                indexDestino: -1,
                tipo: 'completo',
                diasSeleccionados: []
            };
        }

        function confirmarIntercambio() {
            const personaDestino = document.getElementById('select-persona-destino').value;
            
            if (!personaDestino) {
                alert('Por favor selecciona un t√©cnico');
                return;
            }
            
            if (intercambioActual.tipo === 'completo') {
                // Intercambio completo (como antes)
                const guardiaDestino = document.getElementById('select-guardia-destino').value;
                
                if (guardiaDestino === '') {
                    alert('Por favor selecciona una guardia');
                    return;
                }
                
                intercambioActual.personaDestino = personaDestino;
                intercambioActual.indexDestino = parseInt(guardiaDestino);
                
                // Realizar el intercambio completo
                const guardiaOrigen = GUARDIAS[intercambioActual.personaOrigen][intercambioActual.indexOrigen];
                const guardiaDestinoData = GUARDIAS[intercambioActual.personaDestino][intercambioActual.indexDestino];
                
                // Intercambiar
                GUARDIAS[intercambioActual.personaOrigen][intercambioActual.indexOrigen] = guardiaDestinoData;
                GUARDIAS[intercambioActual.personaDestino][intercambioActual.indexDestino] = guardiaOrigen;
                
                alert('‚úÖ Guardias intercambiadas correctamente');
                
            } else {
                // Pasar d√≠as espec√≠ficos
                const checkboxes = document.querySelectorAll('#dias-disponibles input[type="checkbox"]:checked');
                
                if (checkboxes.length === 0) {
                    alert('Por favor selecciona al menos un d√≠a');
                    return;
                }
                
                const diasSeleccionados = Array.from(checkboxes).map(cb => cb.value).sort();
                
                // Pasar d√≠as al otro t√©cnico
                pasarDiasAOtroTecnico(
                    intercambioActual.personaOrigen,
                    intercambioActual.indexOrigen,
                    personaDestino,
                    diasSeleccionados
                );
                
                alert(`‚úÖ ${diasSeleccionados.length} d√≠a(s) pasado(s) a ${personaDestino}`);
            }
            
            // Guardar y actualizar
            guardarGuardias();
            cargarResumen();
            cargarPersonas();
            updateCalendar();
            cargarConflictos();
            cargarHoy();
            cerrarModalIntercambio();
        }

        function pasarDiasAOtroTecnico(personaOrigen, guardiaIndex, personaDestino, diasAPasar) {
            const guardiaOriginal = GUARDIAS[personaOrigen][guardiaIndex];
            const inicioOriginal = guardiaOriginal[0];
            const finOriginal = guardiaOriginal[1];
            
            // Convertir d√≠as a pasar en rangos
            const rangosAPasar = convertirDiasEnRangos(diasAPasar);
            
            // Eliminar la guardia original
            GUARDIAS[personaOrigen].splice(guardiaIndex, 1);
            
            // Crear rangos para el origen (d√≠as que NO se pasan)
            const todosDias = obtenerDiasEnRango(inicioOriginal, finOriginal);
            const diasQueQuedan = todosDias.filter(dia => !diasAPasar.includes(dia));
            const rangosQueQuedan = convertirDiasEnRangos(diasQueQuedan);
            
            // A√±adir rangos que quedan al origen
            rangosQueQuedan.forEach(([inicio, fin]) => {
                GUARDIAS[personaOrigen].push([inicio, fin]);
            });
            
            // A√±adir rangos que se pasan al destino
            rangosAPasar.forEach(([inicio, fin]) => {
                GUARDIAS[personaDestino].push([inicio, fin]);
            });
            
            // Ordenar guardias
            GUARDIAS[personaOrigen].sort((a, b) => a[0].localeCompare(b[0]));
            GUARDIAS[personaDestino].sort((a, b) => a[0].localeCompare(b[0]));
        }

        function obtenerDiasEnRango(inicio, fin) {
            const dias = [];
            const fechaActual = new Date(inicio);
            const fechaFin = new Date(fin);
            
            while (fechaActual <= fechaFin) {
                dias.push(fechaActual.toISOString().split('T')[0]);
                fechaActual.setDate(fechaActual.getDate() + 1);
            }
            
            return dias;
        }

        function convertirDiasEnRangos(dias) {
            if (dias.length === 0) return [];
            
            dias.sort();
            const rangos = [];
            let inicio = dias[0];
            let fin = dias[0];
            
            for (let i = 1; i < dias.length; i++) {
                const diaActual = new Date(dias[i]);
                const diaAnterior = new Date(dias[i - 1]);
                
                // Verificar si son d√≠as consecutivos
                const diffDias = (diaActual - diaAnterior) / (1000 * 60 * 60 * 24);
                
                if (diffDias === 1) {
                    fin = dias[i];
                } else {
                    rangos.push([inicio, fin]);
                    inicio = dias[i];
                    fin = dias[i];
                }
            }
            
            rangos.push([inicio, fin]);
            return rangos;
        }

        function guardarGuardias() {
            if (isLocalMode) {
                localStorage.setItem('guardias_2026', JSON.stringify(GUARDIAS));
                console.log('Guardias guardadas en localStorage');
            }
        }

        function guardarTecnicos() {
            if (isLocalMode) {
                localStorage.setItem('tecnicos_2026', JSON.stringify(TECNICOS));
                console.log('T√©cnicos guardados en localStorage');
            }
        }

        function guardarVacaciones() {
            if (isLocalMode) {
                localStorage.setItem('vacaciones_2026', JSON.stringify(VACACIONES));
                console.log('Vacaciones guardadas en localStorage');
            }
        }

        function guardarFestivos() {
            if (isLocalMode) {
                localStorage.setItem('festivos_2026', JSON.stringify(FESTIVOS));
                console.log('Festivos guardados en localStorage');
            }
        }

        function guardarGuardiasHuerfanas(guardias) {
            if (isLocalMode) {
                localStorage.setItem('guardias_huerfanas', JSON.stringify(guardias));
            }
        }

        function cargarGuardiasHuerfanas() {
            if (isLocalMode) {
                const guardias = localStorage.getItem('guardias_huerfanas');
                return guardias ? JSON.parse(guardias) : [];
            }
            return [];
        }

        // Gesti√≥n de T√©cnicos
        function a√±adirTecnico() {
            const nombre = document.getElementById('input-nuevo-tecnico').value.trim().toUpperCase();
            
            if (!nombre) {
                alert('Por favor introduce un nombre');
                return;
            }
            
            if (TECNICOS[nombre]) {
                alert('Este t√©cnico ya existe');
                return;
            }
            
            TECNICOS[nombre] = true;
            GUARDIAS[nombre] = [];
            guardarTecnicos();
            guardarGuardias();
            actualizarSelectsTecnicos();
            cargarResumen();
            cargarPersonas();
            
            document.getElementById('input-nuevo-tecnico').value = '';
            alert(`‚úÖ T√©cnico ${nombre} a√±adido correctamente`);
        }

        function eliminarTecnico() {
            const nombre = document.getElementById('select-eliminar-tecnico').value;
            
            if (!nombre) {
                alert('Por favor selecciona un t√©cnico');
                return;
            }
            
            if (!confirm(`¬øEst√°s seguro de eliminar a ${nombre}? Sus guardias se marcar√°n como hu√©rfanas.`)) {
                return;
            }
            
            // Guardar guardias hu√©rfanas
            const guardiasHuerfanas = cargarGuardiasHuerfanas();
            const guardiasDelTecnico = GUARDIAS[nombre] || [];
            
            guardiasDelTecnico.forEach(([inicio, fin]) => {
                guardiasHuerfanas.push({
                    tecnicoAnterior: nombre,
                    inicio,
                    fin
                });
            });
            
            guardarGuardiasHuerfanas(guardiasHuerfanas);
            
            // Eliminar t√©cnico
            delete TECNICOS[nombre];
            delete GUARDIAS[nombre];
            if (VACACIONES[nombre]) {
                delete VACACIONES[nombre];
            }
            
            guardarTecnicos();
            guardarGuardias();
            guardarVacaciones();
            actualizarSelectsTecnicos();
            cargarResumen();
            cargarPersonas();
            updateCalendar();
            mostrarGuardiasHuerfanas();
            
            alert(`‚úÖ T√©cnico ${nombre} eliminado. Sus guardias est√°n en la secci√≥n de hu√©rfanas.`);
        }

        function mostrarGuardiasHuerfanas() {
            const guardias = cargarGuardiasHuerfanas();
            const container = document.getElementById('guardias-huerfanas');
            const lista = document.getElementById('lista-guardias-huerfanas');
            
            if (guardias.length === 0) {
                container.style.display = 'none';
                return;
            }
            
            container.style.display = 'block';
            let html = '';
            
            guardias.forEach((guardia, index) => {
                html += `
                    <div class="guardia-huerfana">
                        <div>
                            <strong>Anterior: ${guardia.tecnicoAnterior}</strong><br>
                            ${new Date(guardia.inicio).toLocaleDateString('es-ES')} - 
                            ${new Date(guardia.fin).toLocaleDateString('es-ES')}
                        </div>
                        <button class="btn-reasignar" onclick="reasignarGuardia(${index})">
                            Reasignar
                        </button>
                    </div>
                `;
            });
            
            lista.innerHTML = html;
        }

        function reasignarGuardia(index) {
            const guardias = cargarGuardiasHuerfanas();
            const guardia = guardias[index];
            
            const tecnicos = Object.keys(GUARDIAS);
            let opciones = tecnicos.map(t => `${t}`).join('\n');
            
            const nuevoTecnico = prompt(
                `Reasignar guardia a:\n(${guardia.inicio} - ${guardia.fin})\n\nT√©cnicos disponibles:\n${opciones}\n\nNombre del t√©cnico:`
            );
            
            if (!nuevoTecnico) return;
            
            const tecnicoUpper = nuevoTecnico.trim().toUpperCase();
            
            if (!GUARDIAS[tecnicoUpper]) {
                alert('T√©cnico no encontrado');
                return;
            }
            
            GUARDIAS[tecnicoUpper].push([guardia.inicio, guardia.fin]);
            guardias.splice(index, 1);
            
            guardarGuardiasHuerfanas(guardias);
            guardarGuardias();
            
            cargarResumen();
            cargarPersonas();
            updateCalendar();
            cargarConflictos();
            mostrarGuardiasHuerfanas();
            
            alert(`‚úÖ Guardia reasignada a ${tecnicoUpper}`);
        }

        // Gesti√≥n de Guardias
        function a√±adirGuardia() {
            const tecnico = document.getElementById('select-tecnico-guardia').value;
            const inicio = document.getElementById('input-guardia-inicio').value;
            const fin = document.getElementById('input-guardia-fin').value;
            
            if (!tecnico || !inicio || !fin) {
                alert('Por favor completa todos los campos');
                return;
            }
            
            if (inicio > fin) {
                alert('La fecha de inicio debe ser anterior a la fecha de fin');
                return;
            }
            
            GUARDIAS[tecnico].push([inicio, fin]);
            
            // Ordenar guardias por fecha
            GUARDIAS[tecnico].sort((a, b) => a[0].localeCompare(b[0]));
            
            guardarGuardias();
            cargarResumen();
            cargarPersonas();
            updateCalendar();
            cargarConflictos();
            
            document.getElementById('input-guardia-inicio').value = '';
            document.getElementById('input-guardia-fin').value = '';
            
            alert(`‚úÖ Guardia a√±adida a ${tecnico}`);
        }

        let edicionGuardiaActual = {
            persona: '',
            index: -1
        };

        function editarGuardia(persona, index) {
            const guardia = GUARDIAS[persona][index];
            
            edicionGuardiaActual.persona = persona;
            edicionGuardiaActual.index = index;
            
            document.getElementById('edit-guardia-tecnico').value = persona;
            document.getElementById('edit-guardia-inicio').value = guardia[0];
            document.getElementById('edit-guardia-fin').value = guardia[1];
            
            document.getElementById('modal-editar-guardia').classList.add('active');
        }

        function cerrarModalEditarGuardia() {
            document.getElementById('modal-editar-guardia').classList.remove('active');
            edicionGuardiaActual = { persona: '', index: -1 };
        }

        function guardarEdicionGuardia() {
            const inicio = document.getElementById('edit-guardia-inicio').value;
            const fin = document.getElementById('edit-guardia-fin').value;
            
            if (!inicio || !fin) {
                alert('Por favor completa todos los campos');
                return;
            }
            
            if (inicio > fin) {
                alert('La fecha de inicio debe ser anterior a la fecha de fin');
                return;
            }
            
            // Actualizar la guardia
            GUARDIAS[edicionGuardiaActual.persona][edicionGuardiaActual.index] = [inicio, fin];
            
            // Ordenar guardias por fecha
            GUARDIAS[edicionGuardiaActual.persona].sort((a, b) => a[0].localeCompare(b[0]));
            
            guardarGuardias();
            cargarResumen();
            cargarPersonas();
            updateCalendar();
            cargarConflictos();
            cargarHoy();
            
            cerrarModalEditarGuardia();
            alert('‚úÖ Guardia actualizada correctamente');
        }

        function eliminarGuardia(persona, index) {
            const guardia = GUARDIAS[persona][index];
            const inicioDate = new Date(guardia[0]);
            const finDate = new Date(guardia[1]);
            
            if (!confirm(`¬øEst√°s seguro de eliminar esta guardia?\n\n${persona}\n${inicioDate.toLocaleDateString('es-ES')} - ${finDate.toLocaleDateString('es-ES')}`)) {
                return;
            }
            
            GUARDIAS[persona].splice(index, 1);
            
            guardarGuardias();
            cargarResumen();
            cargarPersonas();
            updateCalendar();
            cargarConflictos();
            cargarHoy();
            
            alert('‚úÖ Guardia eliminada correctamente');
        }

        // Gesti√≥n de Vacaciones
        function a√±adirVacaciones() {
            const tecnico = document.getElementById('select-tecnico-vacaciones').value;
            const inicio = document.getElementById('input-vacaciones-inicio').value;
            const fin = document.getElementById('input-vacaciones-fin').value;
            const descripcion = document.getElementById('input-vacaciones-desc').value.trim();
            
            if (!tecnico || !inicio || !fin) {
                alert('Por favor completa todos los campos obligatorios');
                return;
            }
            
            if (inicio > fin) {
                alert('La fecha de inicio debe ser anterior a la fecha de fin');
                return;
            }
            
            if (!VACACIONES[tecnico]) {
                VACACIONES[tecnico] = [];
            }
            
            VACACIONES[tecnico].push([inicio, fin, descripcion || 'Vacaciones']);
            
            // Ordenar vacaciones por fecha
            VACACIONES[tecnico].sort((a, b) => a[0].localeCompare(b[0]));
            
            guardarVacaciones();
            cargarResumen();
            cargarPersonas();
            updateCalendar();
            cargarConflictos();
            cargarVacacionesLista();
            
            document.getElementById('input-vacaciones-inicio').value = '';
            document.getElementById('input-vacaciones-fin').value = '';
            document.getElementById('input-vacaciones-desc').value = '';
            
            alert(`‚úÖ Vacaciones a√±adidas a ${tecnico}`);
        }

        let edicionVacacionesActual = {
            persona: '',
            index: -1
        };

        function editarVacaciones(persona, index) {
            const vacacion = VACACIONES[persona][index];
            
            edicionVacacionesActual.persona = persona;
            edicionVacacionesActual.index = index;
            
            document.getElementById('edit-vacaciones-tecnico').value = persona;
            document.getElementById('edit-vacaciones-inicio').value = vacacion[0];
            document.getElementById('edit-vacaciones-fin').value = vacacion[1];
            document.getElementById('edit-vacaciones-desc').value = vacacion[2] || '';
            
            document.getElementById('modal-editar-vacaciones').classList.add('active');
        }

        function cerrarModalEditarVacaciones() {
            document.getElementById('modal-editar-vacaciones').classList.remove('active');
            edicionVacacionesActual = { persona: '', index: -1 };
        }

        function guardarEdicionVacaciones() {
            const inicio = document.getElementById('edit-vacaciones-inicio').value;
            const fin = document.getElementById('edit-vacaciones-fin').value;
            const descripcion = document.getElementById('edit-vacaciones-desc').value.trim();
            
            if (!inicio || !fin) {
                alert('Por favor completa todos los campos');
                return;
            }
            
            if (inicio > fin) {
                alert('La fecha de inicio debe ser anterior a la fecha de fin');
                return;
            }
            
            // Actualizar la vacaci√≥n
            VACACIONES[edicionVacacionesActual.persona][edicionVacacionesActual.index] = [
                inicio,
                fin,
                descripcion || 'Vacaciones'
            ];
            
            // Ordenar vacaciones por fecha
            VACACIONES[edicionVacacionesActual.persona].sort((a, b) => a[0].localeCompare(b[0]));
            
            guardarVacaciones();
            cargarResumen();
            cargarPersonas();
            updateCalendar();
            cargarConflictos();
            cargarVacacionesLista();
            
            cerrarModalEditarVacaciones();
            alert('‚úÖ Vacaciones actualizadas correctamente');
        }

        function eliminarVacaciones(persona, index) {
            const vacacion = VACACIONES[persona][index];
            const inicioDate = new Date(vacacion[0]);
            const finDate = new Date(vacacion[1]);
            const desc = vacacion[2] || 'Vacaciones';
            
            if (!confirm(`¬øEst√°s seguro de eliminar estas vacaciones?\n\n${persona}\n${inicioDate.toLocaleDateString('es-ES')} - ${finDate.toLocaleDateString('es-ES')}\n${desc}`)) {
                return;
            }
            
            VACACIONES[persona].splice(index, 1);
            
            // Si no quedan vacaciones, eliminar el array vac√≠o
            if (VACACIONES[persona].length === 0) {
                delete VACACIONES[persona];
            }
            
            guardarVacaciones();
            cargarResumen();
            cargarPersonas();
            updateCalendar();
            cargarConflictos();
            cargarVacacionesLista();
            
            alert('‚úÖ Vacaciones eliminadas correctamente');
        }

        // Gesti√≥n de Festivos
        function a√±adirFestivo() {
            const fecha = document.getElementById('input-festivo-fecha').value;
            const nombre = document.getElementById('input-festivo-nombre').value.trim();
            const medioDia = document.getElementById('check-medio-dia').checked;
            
            if (!fecha || !nombre) {
                alert('Por favor completa todos los campos');
                return;
            }
            
            const nombreFinal = medioDia ? `${nombre} (media jornada)` : nombre;
            FESTIVOS[fecha] = nombreFinal;
            
            guardarFestivos();
            updateCalendar();
            cargarFestivos();
            
            document.getElementById('input-festivo-fecha').value = '';
            document.getElementById('input-festivo-nombre').value = '';
            document.getElementById('check-medio-dia').checked = false;
            
            alert(`‚úÖ Festivo a√±adido: ${nombreFinal}`);
        }

        function actualizarSelectsTecnicos() {
            const tecnicos = Object.keys(TECNICOS).sort();
            
            // Select para eliminar t√©cnico
            const selectEliminar = document.getElementById('select-eliminar-tecnico');
            if (selectEliminar) {
                selectEliminar.innerHTML = '<option value="">Selecciona un t√©cnico...</option>';
                tecnicos.forEach(tecnico => {
                    selectEliminar.innerHTML += `<option value="${tecnico}">${tecnico}</option>`;
                });
            }
            
            // Select para a√±adir guardia
            const selectGuardia = document.getElementById('select-tecnico-guardia');
            if (selectGuardia) {
                selectGuardia.innerHTML = '<option value="">Selecciona un t√©cnico...</option>';
                tecnicos.forEach(tecnico => {
                    selectGuardia.innerHTML += `<option value="${tecnico}">${tecnico}</option>`;
                });
            }
            
            // Select para a√±adir vacaciones
            const selectVacaciones = document.getElementById('select-tecnico-vacaciones');
            if (selectVacaciones) {
                selectVacaciones.innerHTML = '<option value="">Selecciona un t√©cnico...</option>';
                tecnicos.forEach(tecnico => {
                    selectVacaciones.innerHTML += `<option value="${tecnico}">${tecnico}</option>`;
                });
            }
        }

        function resetearGuardias() {
            if (confirm('¬øEst√°s seguro de que quieres restaurar todos los datos originales? Se perder√°n TODOS los cambios (guardias, vacaciones, festivos, t√©cnicos y guardias hu√©rfanas).')) {
                localStorage.removeItem('guardias_2026');
                localStorage.removeItem('vacaciones_2026');
                localStorage.removeItem('festivos_2026');
                localStorage.removeItem('tecnicos_2026');
                localStorage.removeItem('guardias_huerfanas');
                location.reload();
            }
        }

        // Funciones de GitHub
        function mostrarConfigGithub() {
            const config = cargarConfigGithub();
            
            if (config) {
                document.getElementById('input-github-user').value = config.user || '';
                document.getElementById('input-github-repo').value = config.repo || '';
                document.getElementById('input-github-branch').value = config.branch || 'main';
                document.getElementById('input-github-token').value = config.token || '';
            }
            
            document.getElementById('modal-github-config').classList.add('active');
        }

        function cerrarModalGithubConfig() {
            document.getElementById('modal-github-config').classList.remove('active');
        }

        function guardarConfigGithub() {
            const config = {
                user: document.getElementById('input-github-user').value.trim(),
                repo: document.getElementById('input-github-repo').value.trim(),
                branch: document.getElementById('input-github-branch').value.trim() || 'main',
                token: document.getElementById('input-github-token').value.trim()
            };
            
            if (!config.user || !config.repo || !config.token) {
                alert('Por favor completa todos los campos obligatorios');
                return;
            }
            
            // Guardar en localStorage (el token se guarda en base64 para ofuscar, NO es seguridad real)
            localStorage.setItem('github_config', btoa(JSON.stringify(config)));
            
            cerrarModalGithubConfig();
            alert('‚úÖ Configuraci√≥n guardada correctamente');
        }

        function cargarConfigGithub() {
            const configStr = localStorage.getItem('github_config');
            if (!configStr) return null;
            
            try {
                return JSON.parse(atob(configStr));
            } catch (e) {
                return null;
            }
        }

        async function subirCambiosGithub() {
            const config = cargarConfigGithub();
            
            if (!config) {
                if (confirm('No hay configuraci√≥n de GitHub. ¬øQuieres configurarlo ahora?')) {
                    mostrarConfigGithub();
                }
                return;
            }
            
            if (!confirm('¬øEst√°s seguro de que quieres subir los cambios a GitHub?\n\nSe actualizar√°n:\n‚Ä¢ tecnicos.json\n‚Ä¢ guardias.json\n‚Ä¢ vacaciones.json\n‚Ä¢ festivos.json\n\n(El index.html NO se actualiza autom√°ticamente)')) {
                return;
            }
            
            // Mostrar modal de progreso
            document.getElementById('modal-github-progress').classList.add('active');
            actualizarEstadoGithub('Preparando archivos...');
            
            try {
                console.log('Iniciando subida a GitHub...');
                console.log('Usuario:', config.user, 'Repo:', config.repo, 'Branch:', config.branch);
                
                // Preparar solo los JSON (sin HTML por ahora)
                const archivos = [
                    {
                        path: 'tecnicos.json',
                        content: JSON.stringify(TECNICOS, null, 2),
                        message: 'Actualizar t√©cnicos desde modo local'
                    },
                    {
                        path: 'guardias.json',
                        content: JSON.stringify(GUARDIAS, null, 2),
                        message: 'Actualizar guardias desde modo local'
                    },
                    {
                        path: 'vacaciones.json',
                        content: JSON.stringify(VACACIONES, null, 2),
                        message: 'Actualizar vacaciones desde modo local'
                    },
                    {
                        path: 'festivos.json',
                        content: JSON.stringify(FESTIVOS, null, 2),
                        message: 'Actualizar festivos desde modo local'
                    }
                ];
                
                console.log('Archivos preparados:', archivos.length);
                
                // Subir cada archivo
                for (let i = 0; i < archivos.length; i++) {
                    const archivo = archivos[i];
                    console.log(`[${i + 1}/${archivos.length}] Subiendo: ${archivo.path}`);
                    actualizarEstadoGithub(`Subiendo ${archivo.path} (${i + 1}/${archivos.length})...`);
                    
                    try {
                        await subirArchivoGithub(
                            config.user,
                            config.repo,
                            config.branch,
                            archivo.path,
                            archivo.content,
                            archivo.message,
                            config.token
                        );
                        console.log(`‚úÖ ${archivo.path} subido correctamente`);
                    } catch (fileError) {
                        console.error(`‚ùå Error subiendo ${archivo.path}:`, fileError);
                        throw new Error(`Error en ${archivo.path}: ${fileError.message}`);
                    }
                    
                    // Peque√±a pausa entre archivos
                    await new Promise(resolve => setTimeout(resolve, 800));
                }
                
                console.log('‚úÖ Todos los archivos subidos correctamente');
                actualizarEstadoGithub('‚úÖ ¬°Cambios subidos correctamente!');
                
                setTimeout(() => {
                    document.getElementById('modal-github-progress').classList.remove('active');
                    alert('‚úÖ Cambios subidos a GitHub correctamente.\n\nSe han actualizado:\n‚Ä¢ tecnicos.json\n‚Ä¢ guardias.json\n‚Ä¢ vacaciones.json\n‚Ä¢ festivos.json\n\n‚ö†Ô∏è IMPORTANTE: El index.html NO se actualiza autom√°ticamente.\nPara actualizar el HTML, debes subirlo manualmente o usar la versi√≥n que carga desde los JSON.\n\nGitHub Pages puede tardar 1-2 minutos en actualizar.');
                }, 2000);
                
            } catch (error) {
                console.error('‚ùå Error general subiendo a GitHub:', error);
                actualizarEstadoGithub(`‚ùå Error: ${error.message}`);
                
                setTimeout(() => {
                    document.getElementById('modal-github-progress').classList.remove('active');
                    
                    let mensajeError = `Error al subir a GitHub:\n\n${error.message}\n\n`;
                    
                    // Mensajes de ayuda seg√∫n el error
                    if (error.message.includes('401') || error.message.includes('Bad credentials')) {
                        mensajeError += 'üîë El token no es v√°lido o ha expirado.\n\n1. Ve a GitHub Settings ‚Üí Developer settings ‚Üí Personal access tokens\n2. Elimina el token viejo\n3. Crea uno nuevo marcando "repo"\n4. Actualiza la configuraci√≥n aqu√≠';
                    } else if (error.message.includes('404') || error.message.includes('Not Found')) {
                        mensajeError += 'üìÅ El repositorio no existe o el nombre es incorrecto.\n\nVerifica la configuraci√≥n:\nUsuario: ' + config.user + '\nRepo: ' + config.repo;
                    } else if (error.message.includes('403') || error.message.includes('Forbidden')) {
                        mensajeError += 'üîí El token no tiene permisos suficientes.\n\nAl crear el token, aseg√∫rate de marcar el checkbox "repo" (Full control of private repositories)';
                    } else if (error.message.includes('NetworkError') || error.message.includes('Failed to fetch')) {
                        mensajeError += 'üåê Error de conexi√≥n.\n\nVerifica tu conexi√≥n a internet o intenta de nuevo en unos segundos.';
                    } else {
                        mensajeError += 'üìã Abre la consola del navegador (F12 ‚Üí Console) para ver detalles t√©cnicos del error.';
                    }
                    
                    alert(mensajeError);
                }, 2000);
            }
        }

        async function obtenerContenidoHTML() {
            // Esta funci√≥n ya no se usa, pero la dejamos por si acaso
            try {
                console.log('Obteniendo contenido HTML...');
                
                const htmlDoc = document.documentElement.cloneNode(true);
                const scripts = htmlDoc.getElementsByTagName('script');
                let scriptEncontrado = false;
                
                for (let script of scripts) {
                    if (script.textContent.includes('const GUARDIAS =')) {
                        console.log('Script con datos encontrado, actualizando...');
                        scriptEncontrado = true;
                        
                        let scriptContent = script.textContent;
                        
                        const guardiasRegex = /const GUARDIAS = \{[\s\S]*?\};/;
                        const nuevasGuardias = `const GUARDIAS = ${JSON.stringify(GUARDIAS, null, 12)};`;
                        scriptContent = scriptContent.replace(guardiasRegex, nuevasGuardias);
                        
                        const vacacionesRegex = /const VACACIONES = \{[\s\S]*?\};/;
                        const nuevasVacaciones = `const VACACIONES = ${JSON.stringify(VACACIONES, null, 12)};`;
                        scriptContent = scriptContent.replace(vacacionesRegex, nuevasVacaciones);
                        
                        const festivosRegex = /const FESTIVOS = \{[\s\S]*?\};/;
                        const nuevosFestivos = `const FESTIVOS = ${JSON.stringify(FESTIVOS, null, 12)};`;
                        scriptContent = scriptContent.replace(festivosRegex, nuevosFestivos);
                        
                        script.textContent = scriptContent;
                        console.log('Datos actualizados en el script');
                        break;
                    }
                }
                
                if (!scriptEncontrado) {
                    throw new Error('No se encontr√≥ el script con los datos en el HTML');
                }
                
                const htmlCompleto = '<!DOCTYPE html>\n' + htmlDoc.outerHTML;
                console.log('HTML completo generado');
                return htmlCompleto;
                
            } catch (error) {
                console.error('Error generando HTML:', error);
                throw new Error(`Error preparando HTML: ${error.message}`);
            }
        }

        function actualizarEstadoGithub(mensaje) {
            document.getElementById('github-status').textContent = mensaje;
        }

        async function subirArchivoGithub(user, repo, branch, path, content, message, token) {
            const apiUrl = `https://api.github.com/repos/${user}/${repo}/contents/${path}`;
            
            // Primero obtener el SHA actual del archivo (si existe)
            let sha = null;
            try {
                const getResponse = await fetch(apiUrl, {
                    method: 'GET',
                    headers: {
                        'Authorization': `token ${token}`,
                        'Accept': 'application/vnd.github.v3+json'
                    }
                });
                
                if (getResponse.ok) {
                    const data = await getResponse.json();
                    sha = data.sha;
                }
            } catch (e) {
                // El archivo no existe, se crear√°
            }
            
            // Subir o actualizar el archivo
            const payload = {
                message: message,
                content: btoa(unescape(encodeURIComponent(content))), // Base64 encode UTF-8
                branch: branch
            };
            
            if (sha) {
                payload.sha = sha; // Necesario para actualizar
            }
            
            const response = await fetch(apiUrl, {
                method: 'PUT',
                headers: {
                    'Authorization': `token ${token}`,
                    'Accept': 'application/vnd.github.v3+json',
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify(payload)
            });
            
            if (!response.ok) {
                const errorData = await response.json();
                throw new Error(errorData.message || `Error HTTP: ${response.status}`);
            }
            
            return await response.json();
        }

        // Iniciar al cargar la p√°gina
        window.onload = inicializarApp;
    </script>
</body>
</html>