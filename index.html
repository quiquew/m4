<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Guardias 2026 - Sistema de Gesti√≥n</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        :root {
            --primary-color: #4CAF50;
            --secondary-color: #2196F3;
            --danger-color: #e74c3c;
            --warning-color: #f39c12;
            --dark-color: #2c3e50;
            --light-color: #f8f9fa;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }
        
        .container {
            max-width: 1400px;
            margin: 0 auto;
            background: white;
            border-radius: 20px;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
            padding: 30px;
        }
        
        header {
            text-align: center;
            margin-bottom: 40px;
            padding-bottom: 20px;
            border-bottom: 3px solid var(--primary-color);
        }
        
        h1 {
            font-size: 2.5em;
            color: var(--dark-color);
            margin-bottom: 10px;
        }
        
        .subtitle {
            color: #7f8c8d;
            font-size: 1.2em;
        }
        
        .controls {
            display: flex;
            flex-wrap: wrap;
            gap: 15px;
            margin-bottom: 30px;
            justify-content: center;
        }
        
        .btn {
            padding: 12px 24px;
            background: linear-gradient(135deg, #6a11cb 0%, #2575fc 100%);
            color: white;
            border: none;
            border-radius: 10px;
            cursor: pointer;
            font-size: 16px;
            font-weight: 600;
            transition: all 0.3s;
        }
        
        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(0,0,0,0.3);
        }
        
        .btn.active {
            background: var(--primary-color);
        }
        
        .section {
            display: none;
            animation: fadeIn 0.5s;
        }
        
        .section.active {
            display: block;
        }
        
        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }
        
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }
        
        .stat-card {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 20px;
            border-radius: 15px;
            text-align: center;
        }
        
        .stat-number {
            font-size: 2.5em;
            font-weight: bold;
            margin: 10px 0;
        }
        
        .stat-label {
            font-size: 1em;
            opacity: 0.9;
        }
        
        .person-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(250px, 1fr));
            gap: 20px;
        }
        
        .person-card {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 25px;
            border-radius: 15px;
            cursor: pointer;
            transition: all 0.3s;
        }
        
        .person-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 30px rgba(0,0,0,0.3);
        }
        
        .person-name {
            font-size: 1.5em;
            font-weight: bold;
            margin-bottom: 10px;
        }
        
        .calendar-month {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
            background: white;
            border-radius: 10px;
            overflow: hidden;
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
        }
        
        .calendar-month th {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 15px;
            font-weight: 700;
        }
        
        .calendar-month td {
            padding: 10px;
            border: 1px solid #e0e0e0;
            vertical-align: top;
            min-height: 100px;
            position: relative;
        }
        
        .day-number {
            font-weight: bold;
            margin-bottom: 5px;
            color: var(--dark-color);
        }
        
        .today {
            background: #fff3cd !important;
        }
        
        .guardia-event {
            background: var(--primary-color);
            color: white;
            padding: 3px 6px;
            margin: 2px 0;
            border-radius: 5px;
            font-size: 0.75em;
            display: block;
        }
        
        .festivo-day {
            background: rgba(231, 76, 60, 0.1) !important;
        }
        
        .festivo-label {
            background: var(--danger-color);
            color: white;
            padding: 3px 6px;
            border-radius: 5px;
            font-size: 0.7em;
            display: block;
            margin-top: 5px;
        }
        
        .vacaciones-event {
            background: var(--secondary-color);
            color: white;
            padding: 3px 6px;
            margin: 2px 0;
            border-radius: 5px;
            font-size: 0.75em;
            display: block;
        }
        
        .cal-controls {
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            gap: 15px;
            margin-bottom: 20px;
        }
        
        .cal-title {
            font-size: 1.5em;
            font-weight: bold;
            color: var(--dark-color);
        }
        
        .event-list {
            margin-top: 20px;
        }
        
        .event-item {
            background: var(--light-color);
            padding: 15px;
            margin-bottom: 10px;
            border-radius: 10px;
            border-left: 4px solid var(--primary-color);
        }
        
        .event-date {
            font-weight: bold;
            color: var(--dark-color);
        }
        
        .btn-small {
            padding: 8px 16px;
            background: white;
            color: var(--dark-color);
            border: 2px solid white;
            border-radius: 8px;
            cursor: pointer;
            font-size: 0.85em;
            font-weight: 600;
            transition: all 0.3s;
        }
        
        .btn-small:hover {
            background: rgba(255, 255, 255, 0.2);
            border-color: rgba(255, 255, 255, 0.5);
            transform: translateY(-2px);
        }
        
        /* Controles de edici√≥n solo en modo local */
        .edit-controls {
            display: none;
        }
        
        .local-mode .edit-controls {
            display: block;
        }
        
        .btn-edit {
            padding: 6px 12px;
            background: var(--warning-color);
            color: white;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 0.8em;
            font-weight: 600;
            margin-top: 5px;
            transition: all 0.3s;
        }
        
        .btn-edit:hover {
            background: #e67e22;
            transform: scale(1.05);
        }
        
        .guardia-item {
            background: rgba(255, 255, 255, 0.2);
            padding: 8px;
            margin: 5px 0;
            border-radius: 6px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        /* Modal para intercambio */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.7);
            z-index: 1000;
            justify-content: center;
            align-items: center;
        }
        
        .modal.active {
            display: flex;
        }
        
        .modal-content {
            background: white;
            padding: 30px;
            border-radius: 15px;
            max-width: 500px;
            width: 90%;
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.3);
        }
        
        .modal-header {
            font-size: 1.5em;
            font-weight: bold;
            margin-bottom: 20px;
            color: var(--dark-color);
        }
        
        .modal-body {
            margin-bottom: 20px;
        }
        
        .modal-footer {
            display: flex;
            gap: 10px;
            justify-content: flex-end;
        }
        
        .form-group {
            margin-bottom: 15px;
        }
        
        .form-group label {
            display: block;
            margin-bottom: 5px;
            font-weight: 600;
            color: var(--dark-color);
        }
        
        .form-group select {
            width: 100%;
            padding: 10px;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            font-size: 1em;
        }
        
        .btn-cancel {
            padding: 10px 20px;
            background: #95a5a6;
            color: white;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 600;
        }
        
        .btn-confirm {
            padding: 10px 20px;
            background: var(--primary-color);
            color: white;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 600;
        }
        
        .alert {
            padding: 15px;
            margin-bottom: 20px;
            border-radius: 8px;
            font-weight: 600;
        }
        
        .alert-info {
            background: #d1ecf1;
            color: #0c5460;
            border: 1px solid #bee5eb;
        }
        
        .alert-warning {
            background: #fff3cd;
            color: #856404;
            border: 1px solid #ffeaa7;
        }
        
        .conflict-item {
            background: linear-gradient(135deg, #ff6b6b, #ee5a6f);
            color: white;
            padding: 20px;
            margin-bottom: 15px;
            border-radius: 12px;
            box-shadow: 0 4px 15px rgba(255, 107, 107, 0.3);
        }
        
        .conflict-header {
            font-size: 1.3em;
            font-weight: bold;
            margin-bottom: 10px;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .conflict-details {
            background: rgba(255, 255, 255, 0.2);
            padding: 15px;
            border-radius: 8px;
            margin-top: 10px;
        }
        
        .conflict-badge {
            background: var(--warning-color);
            padding: 5px 12px;
            border-radius: 20px;
            font-size: 0.85em;
            font-weight: bold;
        }
        
        .no-conflicts {
            text-align: center;
            padding: 40px;
            background: linear-gradient(135deg, #11998e, #38ef7d);
            color: white;
            border-radius: 15px;
            font-size: 1.2em;
            font-weight: bold;
        }
        
        .vacation-highlight {
            background: rgba(33, 150, 243, 0.3) !important;
            border: 2px solid var(--secondary-color) !important;
        }
        
        .conflict-highlight {
            background: rgba(255, 107, 107, 0.3) !important;
            border: 2px solid #ff6b6b !important;
            animation: pulse 2s infinite;
        }
        
        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.7; }
        }
        
        @media (max-width: 768px) {
            .container {
                padding: 15px;
            }
            
            .controls {
                flex-direction: column;
            }
            
            .calendar-month td {
                padding: 5px;
                font-size: 0.85em;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- Alerta de modo local -->
        <div class="edit-controls">
            <div class="alert alert-info">
                ‚ÑπÔ∏è <strong>Modo Local:</strong> Puedes intercambiar guardias entre t√©cnicos. Los cambios se guardar√°n en tu navegador.
            </div>
        </div>
        
        <header>
            <h1>üìÖ Guardias 2026</h1>
            <div class="subtitle">Sistema de visualizaci√≥n de guardias, festivos y vacaciones</div>
        </header>
        
        <div class="controls">
            <button class="btn active" onclick="showSection('resumen')">üìä Resumen</button>
            <button class="btn" onclick="showSection('personas')">üë• Personas</button>
            <button class="btn" onclick="showSection('calendario')">üìÖ Calendario</button>
            <button class="btn" onclick="showSection('conflictos')">‚ö†Ô∏è Conflictos</button>
            <button class="btn" onclick="showSection('hoy')">üéØ Hoy</button>
            <button class="btn" onclick="showSection('festivos')">üéä Festivos</button>
            <button class="btn" onclick="showSection('vacaciones')">üèñÔ∏è Vacaciones</button>
            <button class="btn edit-controls" onclick="resetearGuardias()" style="background: var(--danger-color);">
                üîÑ Resetear Cambios
            </button>
        </div>
        
        <div id="resumen" class="section active">
            <h2>üìä Resumen General</h2>
            <div class="stats-grid" id="stats-grid">
                <div class="stat-card">
                    <div class="stat-label">Total Personas</div>
                    <div class="stat-number" id="total-personas">0</div>
                </div>
            </div>
            <div class="person-grid" id="resumen-grid"></div>
        </div>
        
        <div id="personas" class="section">
            <h2>üë• Personas y sus Guardias</h2>
            <div class="person-grid" id="personas-grid"></div>
        </div>
        
        <div id="calendario" class="section">
            <h2>üìÖ Calendario de Guardias</h2>
            <div class="cal-controls">
                <button class="btn" onclick="prevMonth()">‚óÄ Anterior</button>
                <div class="cal-title" id="calendar-title"></div>
                <button class="btn" onclick="nextMonth()">Siguiente ‚ñ∂</button>
            </div>
            <table class="calendar-month" id="calendar-month"></table>
        </div>
        
        <div id="conflictos" class="section">
            <h2>‚ö†Ô∏è Detecci√≥n de Conflictos</h2>
            <div class="alert alert-info">
                Esta secci√≥n detecta autom√°ticamente cuando un t√©cnico tiene guardia durante sus vacaciones.
            </div>
            <div id="conflictos-list"></div>
        </div>
        
        <div id="hoy" class="section">
            <h2>üéØ ¬øQui√©n tiene guardia hoy?</h2>
            <div id="hoy-content"></div>
        </div>
        
        <div id="festivos" class="section">
            <h2>üéä Festivos durante guardias</h2>
            <div class="event-list" id="festivos-list"></div>
        </div>
        
        <div id="vacaciones" class="section">
            <h2>üèñÔ∏è Per√≠odos de Vacaciones</h2>
            <div class="event-list" id="vacaciones-list"></div>
        </div>
    </div>

    <!-- Modal para intercambio de guardias -->
    <div id="modal-intercambio" class="modal">
        <div class="modal-content">
            <div class="modal-header">üîÑ Intercambiar Guardia</div>
            <div class="modal-body">
                <div class="form-group">
                    <label>Guardia a intercambiar:</label>
                    <div id="guardia-origen" style="padding: 10px; background: #f0f0f0; border-radius: 6px; margin-bottom: 15px;"></div>
                </div>
                <div class="form-group">
                    <label>Intercambiar con:</label>
                    <select id="select-persona-destino" class="form-control">
                        <option value="">Selecciona un t√©cnico...</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>Guardia del otro t√©cnico:</label>
                    <select id="select-guardia-destino" class="form-control">
                        <option value="">Selecciona una guardia...</option>
                    </select>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn-cancel" onclick="cerrarModalIntercambio()">Cancelar</button>
                <button class="btn-confirm" onclick="confirmarIntercambio()">Confirmar Intercambio</button>
            </div>
        </div>
    </div>

    <script>
        // DATOS INTEGRADOS EN EL HTML
        const GUARDIAS = {
            "QUIQUE": [
                ["2026-01-01", "2026-01-06"],
                ["2026-02-11", "2026-02-17"],
                ["2026-03-18", "2026-03-24"],
                ["2026-05-20", "2026-05-26"],
                ["2026-07-22", "2026-07-28"],
                ["2026-09-02", "2026-09-08"],
                ["2026-10-28", "2026-11-03"],
                ["2026-11-25", "2026-12-01"]
            ],
            "DANI": [
                ["2026-01-07", "2026-01-13"],
                ["2026-04-01", "2026-04-07"],
                ["2026-05-13", "2026-05-19"],
                ["2026-07-01", "2026-07-07"],
                ["2026-08-05", "2026-08-11"],
                ["2026-10-21", "2026-10-27"],
                ["2026-12-09", "2026-12-15"]
            ],
            "RICARDO": [
                ["2026-01-14", "2026-01-20"],
                ["2026-02-18", "2026-02-24"],
                ["2026-04-22", "2026-04-28"],
                ["2026-06-10", "2026-06-16"],
                ["2026-07-15", "2026-07-21"],
                ["2026-08-12", "2026-08-18"],
                ["2026-09-23", "2026-09-29"],
                ["2026-11-11", "2026-11-17"]
            ],
            "JONA": [
                ["2026-01-21", "2026-01-27"],
                ["2026-02-25", "2026-03-03"],
                ["2026-04-08", "2026-04-14"],
                ["2026-06-17", "2026-06-23"],
                ["2026-08-19", "2026-08-25"],
                ["2026-09-30", "2026-10-06"],
                ["2026-12-16", "2026-12-22"]
            ],
            "PEDRO": [
                ["2026-01-28", "2026-02-03"],
                ["2026-03-04", "2026-03-10"],
                ["2026-04-29", "2026-05-05"],
                ["2026-06-24", "2026-06-30"],
                ["2026-09-09", "2026-09-15"],
                ["2026-10-07", "2026-10-13"],
                ["2026-11-18", "2026-11-24"]
            ],
            "MIGUEL": [
                ["2026-02-04", "2026-02-10"],
                ["2026-03-25", "2026-03-31"],
                ["2026-05-06", "2026-05-12"],
                ["2026-06-03", "2026-06-09"],
                ["2026-07-29", "2026-08-04"],
                ["2026-08-26", "2026-09-01"],
                ["2026-10-14", "2026-10-20"],
                ["2026-12-02", "2026-12-08"]
            ],
            "ANDREU": [
                ["2026-03-11", "2026-03-17"],
                ["2026-04-15", "2026-04-21"],
                ["2026-05-27", "2026-06-02"],
                ["2026-07-08", "2026-07-14"],
                ["2026-09-16", "2026-09-22"],
                ["2026-11-04", "2026-11-10"],
                ["2026-12-23", "2026-12-29"],
                ["2026-12-30", "2026-12-31"]
            ]
        };

        const VACACIONES = {
            "RICARDO": [
                ["2026-01-21", "2026-01-27", "Vacaciones enero"],
                ["2026-03-16", "2026-03-22", "Vacaciones marzo"],
                ["2026-03-30", "2026-04-05", "Vacaciones abril"],
                ["2026-06-29", "2026-07-05", "Vacaciones julio"]
            ],
            "JONA": [
                ["2026-02-09", "2026-02-15", "Vacaciones febrero"],
                ["2026-07-27", "2026-08-09", "Vacaciones verano"],
                ["2026-10-26", "2026-11-01", "Vacaciones noviembre"]
            ],
            "QUIQUE": [
                ["2026-03-23", "2026-03-29", "Vacaciones marzo"],
                ["2026-06-08", "2026-06-14", "Vacaciones junio"],
                ["2026-09-28", "2026-10-11", "Vacaciones octubre"]
            ],
            "PEDRO": [
                ["2026-04-06", "2026-04-12", "Vacaciones abril"],
                ["2026-07-06", "2026-07-26", "Vacaciones verano"]
            ],
            "MIGUEL": [
                ["2026-04-13", "2026-04-26", "Vacaciones abril"]
            ],
            "ANDREU": [
                ["2026-06-15", "2026-06-21", "Vacaciones junio"],
                ["2026-11-16", "2026-11-29", "Vacaciones noviembre"]
            ],
            "DANI": [
                ["2026-08-17", "2026-08-30", "Vacaciones verano"]
            ]
        };

        const FESTIVOS = {
            "2026-01-01": "A√±o Nuevo",
            "2026-01-06": "Epifan√≠a Reyes",
            "2026-01-22": "San Vicente M√°rtir",
            "2026-03-19": "San Jos√©",
            "2026-04-03": "Viernes Santo",
            "2026-04-16": "San Vicente Ferrer",
            "2026-06-24": "San Juan",
            "2026-08-15": "Asunci√≥n de la Virgen",
            "2026-10-09": "D√≠a de la Comunidad Valenciana",
            "2026-10-12": "D√≠a de la Hispanidad",
            "2026-11-01": "D√≠a de todos los santos",
            "2026-12-06": "D√≠a de la constituci√≥n",
            "2026-12-08": "D√≠a de la Inmaculada Concepci√≥n",
            "2026-12-25": "Navidad"
        };

        let currentYear = 2026;
        let currentMonth = 0;
        let isLocalMode = false;

        // Detectar si estamos en modo local o GitHub Pages
        function detectarEntorno() {
            // Detectar si estamos en local (file:// o localhost)
            isLocalMode = window.location.protocol === 'file:' || 
                         window.location.hostname === 'localhost' || 
                         window.location.hostname === '127.0.0.1' ||
                         window.location.hostname === '';
            
            console.log('Modo:', isLocalMode ? 'LOCAL (edici√≥n habilitada)' : 'GITHUB (solo lectura)');
            
            // Mostrar/ocultar controles de edici√≥n
            if (isLocalMode) {
                document.body.classList.add('local-mode');
            }
        }

        function inicializarApp() {
            detectarEntorno();
            
            // En modo local, cargar guardias desde localStorage si existen
            if (isLocalMode) {
                const guardiasGuardadas = localStorage.getItem('guardias_2026');
                if (guardiasGuardadas) {
                    Object.assign(GUARDIAS, JSON.parse(guardiasGuardadas));
                    console.log('Guardias cargadas desde localStorage');
                }
            }
            
            const hoy = new Date();
            currentYear = hoy.getFullYear();
            currentMonth = hoy.getMonth();
            
            cargarResumen();
            cargarPersonas();
            updateCalendar();
            cargarConflictos();
            cargarHoy();
            cargarFestivos();
            cargarVacacionesLista();
        }

        function showSection(sectionId) {
            document.querySelectorAll('.section').forEach(s => s.classList.remove('active'));
            document.getElementById(sectionId).classList.add('active');
            
            document.querySelectorAll('.btn').forEach(btn => btn.classList.remove('active'));
            event.target.classList.add('active');
            
            // Cargar contenido espec√≠fico de la secci√≥n
            if (sectionId === 'conflictos') {
                cargarConflictos();
            }
        }

        function cargarResumen() {
            const grid = document.getElementById('resumen-grid');
            grid.innerHTML = '';
            
            // Contar guardias, vacaciones y festivos por a√±o
            const guardiasPorA√±o = {};
            const vacacionesPorA√±o = {};
            const festivosPorA√±o = {};
            
            // Contar guardias
            for (const [persona, guardias] of Object.entries(GUARDIAS)) {
                guardias.forEach(([inicio]) => {
                    const a√±o = new Date(inicio).getFullYear();
                    guardiasPorA√±o[a√±o] = (guardiasPorA√±o[a√±o] || 0) + 1;
                });
                
                const card = document.createElement('div');
                card.className = 'person-card';
                card.innerHTML = `
                    <div class="person-name">${persona}</div>
                    <div>${guardias.length} guardias asignadas</div>
                `;
                grid.appendChild(card);
            }
            
            // Contar vacaciones
            for (const [persona, vacaciones] of Object.entries(VACACIONES)) {
                vacaciones.forEach(([inicio]) => {
                    const a√±o = new Date(inicio).getFullYear();
                    vacacionesPorA√±o[a√±o] = (vacacionesPorA√±o[a√±o] || 0) + 1;
                });
            }
            
            // Contar festivos
            for (const fecha of Object.keys(FESTIVOS)) {
                const a√±o = new Date(fecha).getFullYear();
                festivosPorA√±o[a√±o] = (festivosPorA√±o[a√±o] || 0) + 1;
            }
            
            // Obtener todos los a√±os √∫nicos y ordenarlos
            const todosLosA√±os = new Set([
                ...Object.keys(guardiasPorA√±o),
                ...Object.keys(vacacionesPorA√±o),
                ...Object.keys(festivosPorA√±o)
            ]);
            const a√±osOrdenados = Array.from(todosLosA√±os).sort();
            
            // Generar stats din√°micamente
            const statsGrid = document.getElementById('stats-grid');
            
            // Total personas siempre aparece
            document.getElementById('total-personas').textContent = Object.keys(GUARDIAS).length;
            
            // Agregar stats por a√±o
            a√±osOrdenados.forEach(a√±o => {
                // Guardias
                if (guardiasPorA√±o[a√±o]) {
                    const card = document.createElement('div');
                    card.className = 'stat-card';
                    card.innerHTML = `
                        <div class="stat-label">Guardias ${a√±o}</div>
                        <div class="stat-number">${guardiasPorA√±o[a√±o]}</div>
                    `;
                    statsGrid.appendChild(card);
                }
                
                // Vacaciones
                if (vacacionesPorA√±o[a√±o]) {
                    const card = document.createElement('div');
                    card.className = 'stat-card';
                    card.innerHTML = `
                        <div class="stat-label">Vacaciones ${a√±o}</div>
                        <div class="stat-number">${vacacionesPorA√±o[a√±o]}</div>
                    `;
                    statsGrid.appendChild(card);
                }
                
                // Festivos
                if (festivosPorA√±o[a√±o]) {
                    const card = document.createElement('div');
                    card.className = 'stat-card';
                    card.innerHTML = `
                        <div class="stat-label">Festivos ${a√±o}</div>
                        <div class="stat-number">${festivosPorA√±o[a√±o]}</div>
                    `;
                    statsGrid.appendChild(card);
                }
            });
        }

        function cargarPersonas() {
            const grid = document.getElementById('personas-grid');
            grid.innerHTML = '';
            
            for (const [persona, guardias] of Object.entries(GUARDIAS)) {
                const card = document.createElement('div');
                card.className = 'person-card';
                
                let guardiasHTML = '';
                guardias.forEach(([inicio, fin], index) => {
                    const inicioDate = new Date(inicio);
                    const finDate = new Date(fin);
                    
                    guardiasHTML += `
                        <div class="guardia-item">
                            <div style="font-size: 0.9em;">
                                ${inicioDate.toLocaleDateString('es-ES')} - ${finDate.toLocaleDateString('es-ES')}
                            </div>
                            ${isLocalMode ? `
                            <button class="btn-edit" onclick="abrirModalIntercambio('${persona}', ${index})">
                                üîÑ Cambiar
                            </button>
                            ` : ''}
                        </div>
                    `;
                });
                
                // Verificar si tiene vacaciones
                const vacaciones = VACACIONES[persona] || [];
                const tieneVacaciones = vacaciones.length > 0;
                
                card.innerHTML = `
                    <div class="person-name">${persona}</div>
                    <div style="margin-top: 10px; opacity: 0.9;">
                        ${guardias.length} guardias
                        ${tieneVacaciones ? ` ‚Ä¢ ${vacaciones.length} per√≠odos de vacaciones` : ''}
                    </div>
                    <div style="margin-top: 10px;">
                        ${guardiasHTML}
                    </div>
                    <div style="margin-top: 15px; display: flex; gap: 10px; flex-wrap: wrap;">
                        <button class="btn-small" onclick="exportarGuardiasCalendario('${persona}')">
                            üìÖ Exportar Guardias
                        </button>
                        ${tieneVacaciones ? `
                        <button class="btn-small" onclick="exportarVacacionesCalendario('${persona}')">
                            üèñÔ∏è Exportar Vacaciones
                        </button>
                        ` : ''}
                    </div>
                `;
                grid.appendChild(card);
            }
        }

        function updateCalendar() {
            const calendar = document.getElementById('calendar-month');
            const monthNames = ["Enero", "Febrero", "Marzo", "Abril", "Mayo", "Junio",
                              "Julio", "Agosto", "Septiembre", "Octubre", "Noviembre", "Diciembre"];
            
            document.getElementById('calendar-title').textContent = 
                `${monthNames[currentMonth]} ${currentYear}`;
            
            const firstDay = new Date(currentYear, currentMonth, 1);
            const lastDay = new Date(currentYear, currentMonth + 1, 0);
            const startDay = firstDay.getDay();
            const daysInMonth = lastDay.getDate();
            
            let html = `
                <thead>
                    <tr>
                        <th>Dom</th><th>Lun</th><th>Mar</th><th>Mi√©</th>
                        <th>Jue</th><th>Vie</th><th>S√°b</th>
                    </tr>
                </thead>
                <tbody>
            `;
            
            let day = 1;
            const hoy = new Date().toISOString().split('T')[0];
            
            for (let i = 0; i < 6; i++) {
                html += '<tr>';
                for (let j = 0; j < 7; j++) {
                    if (i === 0 && j < startDay || day > daysInMonth) {
                        html += '<td></td>';
                    } else {
                        const dateStr = `${currentYear}-${String(currentMonth + 1).padStart(2, '0')}-${String(day).padStart(2, '0')}`;
                        const isToday = dateStr === hoy;
                        const isFestivo = FESTIVOS[dateStr];
                        
                        // Detectar conflictos para este d√≠a
                        const conflictos = detectarConflictosDelDia(dateStr);
                        const tieneVacaciones = tieneVacacionesDelDia(dateStr);
                        
                        let cellClass = isToday ? 'today' : '';
                        if (isFestivo) cellClass += ' festivo-day';
                        if (conflictos.length > 0) cellClass += ' conflict-highlight';
                        else if (tieneVacaciones) cellClass += ' vacation-highlight';
                        
                        html += `<td class="${cellClass}">
                            <div class="day-number">${day}</div>`;
                        
                        // Agregar guardias
                        for (const [persona, guardias] of Object.entries(GUARDIAS)) {
                            guardias.forEach(([inicio, fin]) => {
                                if (dateStr >= inicio && dateStr <= fin) {
                                    const tieneConflicto = conflictos.some(c => c.persona === persona);
                                    const estiloConflicto = tieneConflicto ? 'style="background: #ff6b6b; font-weight: bold;"' : '';
                                    html += `<span class="guardia-event" ${estiloConflicto}>${persona}${tieneConflicto ? ' ‚ö†Ô∏è' : ''}</span>`;
                                }
                            });
                        }
                        
                        // Agregar vacaciones
                        for (const [persona, vacaciones] of Object.entries(VACACIONES)) {
                            vacaciones.forEach(([inicio, fin, desc]) => {
                                if (dateStr >= inicio && dateStr <= fin) {
                                    html += `<span class="vacaciones-event">${persona}: ${desc || 'Vacaciones'}</span>`;
                                }
                            });
                        }
                        
                        // Agregar festivo
                        if (isFestivo) {
                            html += `<span class="festivo-label">${isFestivo}</span>`;
                        }
                        
                        html += '</td>';
                        day++;
                    }
                }
                html += '</tr>';
                if (day > daysInMonth) break;
            }
            
            html += '</tbody>';
            calendar.innerHTML = html;
        }

        function detectarConflictosDelDia(fecha) {
            const conflictos = [];
            
            for (const [persona, guardias] of Object.entries(GUARDIAS)) {
                const vacaciones = VACACIONES[persona] || [];
                
                guardias.forEach(([guardiaInicio, guardiaFin]) => {
                    if (fecha >= guardiaInicio && fecha <= guardiaFin) {
                        // Verificar si est√° de vacaciones en esta fecha
                        vacaciones.forEach(([vacInicio, vacFin]) => {
                            if (fecha >= vacInicio && fecha <= vacFin) {
                                conflictos.push({ persona });
                            }
                        });
                    }
                });
            }
            
            return conflictos;
        }

        function tieneVacacionesDelDia(fecha) {
            for (const vacaciones of Object.values(VACACIONES)) {
                for (const [inicio, fin] of vacaciones) {
                    if (fecha >= inicio && fecha <= fin) {
                        return true;
                    }
                }
            }
            return false;
        }

        function detectarTodosLosConflictos() {
            const conflictos = [];
            
            for (const [persona, guardias] of Object.entries(GUARDIAS)) {
                const vacaciones = VACACIONES[persona] || [];
                
                guardias.forEach(([guardiaInicio, guardiaFin]) => {
                    vacaciones.forEach(([vacInicio, vacFin, descripcion]) => {
                        // Verificar si hay solapamiento
                        const hayConflicto = !(guardiaFin < vacInicio || guardiaInicio > vacFin);
                        
                        if (hayConflicto) {
                            // Calcular d√≠as de solapamiento
                            const inicio = guardiaInicio > vacInicio ? guardiaInicio : vacInicio;
                            const fin = guardiaFin < vacFin ? guardiaFin : vacFin;
                            
                            const diasConflicto = Math.floor(
                                (new Date(fin) - new Date(inicio)) / (1000 * 60 * 60 * 24)
                            ) + 1;
                            
                            conflictos.push({
                                persona,
                                guardiaInicio,
                                guardiaFin,
                                vacInicio,
                                vacFin,
                                descripcion,
                                inicio,
                                fin,
                                diasConflicto
                            });
                        }
                    });
                });
            }
            
            return conflictos;
        }

        function cargarConflictos() {
            const list = document.getElementById('conflictos-list');
            const conflictos = detectarTodosLosConflictos();
            
            if (conflictos.length === 0) {
                list.innerHTML = `
                    <div class="no-conflicts">
                        ‚úÖ ¬°Perfecto! No hay conflictos entre guardias y vacaciones
                    </div>
                `;
                return;
            }
            
            let html = '';
            
            conflictos.forEach(conf => {
                html += `
                    <div class="conflict-item">
                        <div class="conflict-header">
                            ‚ö†Ô∏è ${conf.persona}
                            <span class="conflict-badge">${conf.diasConflicto} d√≠a${conf.diasConflicto > 1 ? 's' : ''}</span>
                        </div>
                        <div class="conflict-details">
                            <div style="margin-bottom: 8px;">
                                <strong>Guardia:</strong> 
                                ${new Date(conf.guardiaInicio).toLocaleDateString('es-ES')} - 
                                ${new Date(conf.guardiaFin).toLocaleDateString('es-ES')}
                            </div>
                            <div style="margin-bottom: 8px;">
                                <strong>Vacaciones:</strong> 
                                ${new Date(conf.vacInicio).toLocaleDateString('es-ES')} - 
                                ${new Date(conf.vacFin).toLocaleDateString('es-ES')}
                                ${conf.descripcion ? `(${conf.descripcion})` : ''}
                            </div>
                            <div style="background: rgba(255, 255, 255, 0.3); padding: 8px; border-radius: 5px; margin-top: 10px;">
                                <strong>‚ö° Conflicto:</strong> 
                                ${new Date(conf.inicio).toLocaleDateString('es-ES')} - 
                                ${new Date(conf.fin).toLocaleDateString('es-ES')}
                            </div>
                        </div>
                    </div>
                `;
            });
            
            list.innerHTML = html;
        }

        function cargarHoy() {
            const content = document.getElementById('hoy-content');
            const hoy = new Date().toISOString().split('T')[0];
            
            let html = '';
            let hayGuardia = false;
            
            for (const [persona, guardias] of Object.entries(GUARDIAS)) {
                guardias.forEach(([inicio, fin]) => {
                    if (hoy >= inicio && hoy <= fin) {
                        hayGuardia = true;
                        html += `
                            <div class="event-item">
                                <div style="font-size: 1.3em; font-weight: bold; margin-bottom: 5px;">
                                    ${persona}
                                </div>
                                <div class="event-date">
                                    Del ${new Date(inicio).toLocaleDateString('es-ES')} 
                                    al ${new Date(fin).toLocaleDateString('es-ES')}
                                </div>
                            </div>
                        `;
                    }
                });
            }
            
            if (!hayGuardia) {
                html = '<div class="event-item">No hay guardias asignadas para hoy</div>';
            }
            
            content.innerHTML = html;
        }

        function cargarFestivos() {
            const list = document.getElementById('festivos-list');
            let html = '';
            
            for (const [fecha, nombre] of Object.entries(FESTIVOS)) {
                // Ver si hay guardias ese d√≠a
                let personasGuardia = [];
                for (const [persona, guardias] of Object.entries(GUARDIAS)) {
                    guardias.forEach(([inicio, fin]) => {
                        if (fecha >= inicio && fecha <= fin) {
                            personasGuardia.push(persona);
                        }
                    });
                }
                
                if (personasGuardia.length > 0) {
                    html += `
                        <div class="event-item">
                            <div class="event-date">${new Date(fecha).toLocaleDateString('es-ES')} - ${nombre}</div>
                            <div style="margin-top: 5px; color: var(--danger-color); font-weight: bold;">
                                Guardias: ${personasGuardia.join(', ')}
                            </div>
                        </div>
                    `;
                }
            }
            
            if (!html) {
                html = '<div class="event-item">No hay festivos durante guardias</div>';
            }
            
            list.innerHTML = html;
        }

        function cargarVacacionesLista() {
            const list = document.getElementById('vacaciones-list');
            let html = '';
            
            for (const [persona, vacaciones] of Object.entries(VACACIONES)) {
                vacaciones.forEach(([inicio, fin, desc]) => {
                    html += `
                        <div class="event-item">
                            <div style="font-weight: bold; margin-bottom: 5px;">${persona}</div>
                            <div class="event-date">
                                ${new Date(inicio).toLocaleDateString('es-ES')} - 
                                ${new Date(fin).toLocaleDateString('es-ES')}
                            </div>
                            <div style="margin-top: 5px; color: var(--secondary-color);">
                                ${desc || 'Vacaciones'}
                            </div>
                        </div>
                    `;
                });
            }
            
            list.innerHTML = html;
        }

        function prevMonth() {
            currentMonth--;
            if (currentMonth < 0) {
                currentMonth = 11;
                currentYear--;
            }
            updateCalendar();
        }

        function nextMonth() {
            currentMonth++;
            if (currentMonth > 11) {
                currentMonth = 0;
                currentYear++;
            }
            updateCalendar();
        }

        // Funciones para exportar a calendario
        function generarICS(eventos, titulo) {
            // Formato ICS (iCalendar)
            let ics = `BEGIN:VCALENDAR
VERSION:2.0
PRODID:-//Guardias 2026//ES
CALSCALE:GREGORIAN
METHOD:PUBLISH
X-WR-CALNAME:${titulo}
X-WR-TIMEZONE:Europe/Madrid
BEGIN:VTIMEZONE
TZID:Europe/Madrid
X-LIC-LOCATION:Europe/Madrid
BEGIN:DAYLIGHT
TZOFFSETFROM:+0100
TZOFFSETTO:+0200
TZNAME:CEST
DTSTART:19700329T020000
RRULE:FREQ=YEARLY;BYMONTH=3;BYDAY=-1SU
END:DAYLIGHT
BEGIN:STANDARD
TZOFFSETFROM:+0200
TZOFFSETTO:+0100
TZNAME:CET
DTSTART:19701025T030000
RRULE:FREQ=YEARLY;BYMONTH=10;BYDAY=-1SU
END:STANDARD
END:VTIMEZONE
`;

            eventos.forEach(evento => {
                const uid = `${Date.now()}-${Math.random().toString(36).substr(2, 9)}@guardias.local`;
                const dtstamp = new Date().toISOString().replace(/[-:]/g, '').split('.')[0] + 'Z';
                
                // Convertir fechas a formato ICS (YYYYMMDD)
                const dtstart = evento.inicio.replace(/-/g, '');
                const dtend = evento.fin.replace(/-/g, '');
                
                ics += `BEGIN:VEVENT
DTSTART;VALUE=DATE:${dtstart}
DTEND;VALUE=DATE:${dtend}
DTSTAMP:${dtstamp}
UID:${uid}
SUMMARY:${evento.titulo}
DESCRIPTION:${evento.descripcion || ''}
STATUS:CONFIRMED
TRANSP:TRANSPARENT
END:VEVENT
`;
            });

            ics += `END:VCALENDAR`;
            return ics;
        }

        function descargarICS(contenido, nombreArchivo) {
            const blob = new Blob([contenido], { type: 'text/calendar;charset=utf-8' });
            const url = URL.createObjectURL(blob);
            const link = document.createElement('a');
            link.href = url;
            link.download = nombreArchivo;
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            URL.revokeObjectURL(url);
        }

        function exportarGuardiasCalendario(persona) {
            const guardias = GUARDIAS[persona];
            if (!guardias || guardias.length === 0) {
                alert('No hay guardias para exportar');
                return;
            }

            const eventos = guardias.map(([inicio, fin]) => {
                // Ajustar fecha de fin para que sea inclusive (a√±adir 1 d√≠a)
                const fechaFin = new Date(fin);
                fechaFin.setDate(fechaFin.getDate() + 1);
                const finAjustado = fechaFin.toISOString().split('T')[0];
                
                return {
                    inicio: inicio,
                    fin: finAjustado,
                    titulo: `Guardia - ${persona}`,
                    descripcion: `Per√≠odo de guardia asignado a ${persona}`
                };
            });

            const ics = generarICS(eventos, `Guardias ${persona}`);
            descargarICS(ics, `guardias_${persona.toLowerCase()}.ics`);
        }

        function exportarVacacionesCalendario(persona) {
            const vacaciones = VACACIONES[persona];
            if (!vacaciones || vacaciones.length === 0) {
                alert('No hay vacaciones para exportar');
                return;
            }

            const eventos = vacaciones.map(([inicio, fin, descripcion]) => {
                // Ajustar fecha de fin para que sea inclusive (a√±adir 1 d√≠a)
                const fechaFin = new Date(fin);
                fechaFin.setDate(fechaFin.getDate() + 1);
                const finAjustado = fechaFin.toISOString().split('T')[0];
                
                return {
                    inicio: inicio,
                    fin: finAjustado,
                    titulo: `Vacaciones - ${persona}`,
                    descripcion: descripcion || 'Per√≠odo vacacional'
                };
            });

            const ics = generarICS(eventos, `Vacaciones ${persona}`);
            descargarICS(ics, `vacaciones_${persona.toLowerCase()}.ics`);
        }

        // Variables para el modal de intercambio
        let intercambioActual = {
            personaOrigen: '',
            indexOrigen: -1,
            personaDestino: '',
            indexDestino: -1
        };

        function abrirModalIntercambio(persona, guardiaIndex) {
            intercambioActual.personaOrigen = persona;
            intercambioActual.indexOrigen = guardiaIndex;
            
            const guardia = GUARDIAS[persona][guardiaIndex];
            const inicioDate = new Date(guardia[0]);
            const finDate = new Date(guardia[1]);
            
            document.getElementById('guardia-origen').innerHTML = `
                <strong>${persona}</strong><br>
                ${inicioDate.toLocaleDateString('es-ES')} - ${finDate.toLocaleDateString('es-ES')}
            `;
            
            // Llenar select de personas (excluyendo la persona actual)
            const selectPersona = document.getElementById('select-persona-destino');
            selectPersona.innerHTML = '<option value="">Selecciona un t√©cnico...</option>';
            
            for (const nombrePersona of Object.keys(GUARDIAS)) {
                if (nombrePersona !== persona) {
                    selectPersona.innerHTML += `<option value="${nombrePersona}">${nombrePersona}</option>`;
                }
            }
            
            // Limpiar select de guardias
            document.getElementById('select-guardia-destino').innerHTML = 
                '<option value="">Primero selecciona un t√©cnico...</option>';
            
            // Event listener para cuando se selecciona una persona
            selectPersona.onchange = function() {
                cargarGuardiasDestino(this.value);
            };
            
            document.getElementById('modal-intercambio').classList.add('active');
        }

        function cargarGuardiasDestino(personaDestino) {
            if (!personaDestino) return;
            
            const selectGuardia = document.getElementById('select-guardia-destino');
            selectGuardia.innerHTML = '<option value="">Selecciona una guardia...</option>';
            
            const guardias = GUARDIAS[personaDestino];
            guardias.forEach((guardia, index) => {
                const inicioDate = new Date(guardia[0]);
                const finDate = new Date(guardia[1]);
                selectGuardia.innerHTML += `
                    <option value="${index}">
                        ${inicioDate.toLocaleDateString('es-ES')} - ${finDate.toLocaleDateString('es-ES')}
                    </option>
                `;
            });
        }

        function cerrarModalIntercambio() {
            document.getElementById('modal-intercambio').classList.remove('active');
            intercambioActual = {
                personaOrigen: '',
                indexOrigen: -1,
                personaDestino: '',
                indexDestino: -1
            };
        }

        function confirmarIntercambio() {
            const personaDestino = document.getElementById('select-persona-destino').value;
            const guardiaDestino = document.getElementById('select-guardia-destino').value;
            
            if (!personaDestino || guardiaDestino === '') {
                alert('Por favor selecciona un t√©cnico y una guardia');
                return;
            }
            
            intercambioActual.personaDestino = personaDestino;
            intercambioActual.indexDestino = parseInt(guardiaDestino);
            
            // Realizar el intercambio
            const guardiaOrigen = GUARDIAS[intercambioActual.personaOrigen][intercambioActual.indexOrigen];
            const guardiaDestinoData = GUARDIAS[intercambioActual.personaDestino][intercambioActual.indexDestino];
            
            // Intercambiar
            GUARDIAS[intercambioActual.personaOrigen][intercambioActual.indexOrigen] = guardiaDestinoData;
            GUARDIAS[intercambioActual.personaDestino][intercambioActual.indexDestino] = guardiaOrigen;
            
            // Guardar en localStorage
            guardarGuardias();
            
            // Actualizar vistas
            cargarResumen();
            cargarPersonas();
            updateCalendar();
            cargarConflictos();
            cargarHoy();
            
            // Cerrar modal
            cerrarModalIntercambio();
            
            alert('‚úÖ Guardias intercambiadas correctamente');
        }

        function guardarGuardias() {
            if (isLocalMode) {
                localStorage.setItem('guardias_2026', JSON.stringify(GUARDIAS));
                console.log('Guardias guardadas en localStorage');
            }
        }

        function resetearGuardias() {
            if (confirm('¬øEst√°s seguro de que quieres restaurar las guardias originales? Se perder√°n todos los cambios.')) {
                localStorage.removeItem('guardias_2026');
                location.reload();
            }
        }

        // Iniciar al cargar la p√°gina
        window.onload = inicializarApp;
    </script>
</body>
</html>